<!DOCTYPE html><html class="hide-aside" lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>BERTå®æˆ˜â€”â€”ï¼ˆ7ï¼‰ç”Ÿæˆä»»åŠ¡-è¯­è¨€æ¨¡å‹ | å†¬äºçš„åšå®¢</title><meta name="keywords" content="æ·±åº¦å­¦ä¹ ,BERT,NLP"><meta name="author" content="å†¬äº"><meta name="copyright" content="å†¬äº"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="BERTå®æˆ˜â€”â€”ï¼ˆ7ï¼‰ç”Ÿæˆä»»åŠ¡-è¯­è¨€æ¨¡å‹ å¼•è¨€ ä¹‹å‰çš„åˆ†åˆ«ä»‹ç»äº†ä½¿ç”¨ ğŸ¤— Transformersä»£ç åº“ä¸­çš„æ¨¡å‹å¼€å±•one-classä»»åŠ¡(æ–‡æœ¬åˆ†ç±»ã€å¤šé€‰é—®ç­”é—®é¢˜)ã€class for each tokenä»»åŠ¡(åºåˆ—æ ‡æ³¨)ã€copy from inputä»»åŠ¡(æŠ½å–å¼é—®ç­”)ä»¥åŠgeneral sequenceä»»åŠ¡ï¼ˆæœºå™¨ç¿»è¯‘ã€æ‘˜è¦æŠ½å–ï¼‰ã€‚ è¿™ä¸€ç¯‡å°†ä»‹ç»å¦‚ä½•ä½¿ç”¨è¯­è¨€æ¨¡å‹ä»»åŠ¡å¾®è°ƒ ğŸ¤— Trans">
<meta property="og:type" content="article">
<meta property="og:title" content="BERTå®æˆ˜â€”â€”ï¼ˆ7ï¼‰ç”Ÿæˆä»»åŠ¡-è¯­è¨€æ¨¡å‹">
<meta property="og:url" content="https://ifwind.github.io/2021/08/31/BERT%E5%AE%9E%E6%88%98%E2%80%94%E2%80%94%EF%BC%887%EF%BC%89%E7%94%9F%E6%88%90%E4%BB%BB%E5%8A%A1-%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B/index.html">
<meta property="og:site_name" content="å†¬äºçš„åšå®¢">
<meta property="og:description" content="BERTå®æˆ˜â€”â€”ï¼ˆ7ï¼‰ç”Ÿæˆä»»åŠ¡-è¯­è¨€æ¨¡å‹ å¼•è¨€ ä¹‹å‰çš„åˆ†åˆ«ä»‹ç»äº†ä½¿ç”¨ ğŸ¤— Transformersä»£ç åº“ä¸­çš„æ¨¡å‹å¼€å±•one-classä»»åŠ¡(æ–‡æœ¬åˆ†ç±»ã€å¤šé€‰é—®ç­”é—®é¢˜)ã€class for each tokenä»»åŠ¡(åºåˆ—æ ‡æ³¨)ã€copy from inputä»»åŠ¡(æŠ½å–å¼é—®ç­”)ä»¥åŠgeneral sequenceä»»åŠ¡ï¼ˆæœºå™¨ç¿»è¯‘ã€æ‘˜è¦æŠ½å–ï¼‰ã€‚ è¿™ä¸€ç¯‡å°†ä»‹ç»å¦‚ä½•ä½¿ç”¨è¯­è¨€æ¨¡å‹ä»»åŠ¡å¾®è°ƒ ğŸ¤— Trans">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://ifwind.github.io/2021/08/26/BERT%E5%AE%9E%E6%88%98%E2%80%94%E2%80%94%EF%BC%881%EF%BC%89%E6%96%87%E6%9C%AC%E5%88%86%E7%B1%BB/huggingFace.jpg">
<meta property="article:published_time" content="2021-08-31T05:59:23.000Z">
<meta property="article:modified_time" content="2021-09-04T12:47:02.698Z">
<meta property="article:author" content="å†¬äº">
<meta property="article:tag" content="æ·±åº¦å­¦ä¹ ">
<meta property="article:tag" content="BERT">
<meta property="article:tag" content="NLP">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://ifwind.github.io/2021/08/26/BERT%E5%AE%9E%E6%88%98%E2%80%94%E2%80%94%EF%BC%881%EF%BC%89%E6%96%87%E6%9C%AC%E5%88%86%E7%B1%BB/huggingFace.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://ifwind.github.io/2021/08/31/BERT%E5%AE%9E%E6%88%98%E2%80%94%E2%80%94%EF%BC%887%EF%BC%89%E7%94%9F%E6%88%90%E4%BB%BB%E5%8A%A1-%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.10.5/dist/instantsearch.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.10.5/dist/instantsearch.min.js" defer></script><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: {"appId":"LVK1P2D38K","apiKey":"8cbbb0bcbb5c7448f68b4fae01d4ccd5","indexName":"DongYu","hits":{"per_page":6},"languages":{"input_placeholder":"æœç´¢æ–‡ç« ","hits_empty":"æ‰¾ä¸åˆ°æ‚¨æŸ¥è¯¢çš„å†…å®¹ï¼š${query}","hits_stats":"æ‰¾åˆ° ${hits} æ¡ç»“æœï¼Œç”¨æ—¶ ${time} æ¯«ç§’"}},
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'å¤åˆ¶æˆåŠŸ',
    error: 'å¤åˆ¶é”™è¯¯',
    noSupport: 'æµè§ˆå™¨ä¸æ”¯æŒ'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: 'å¤©',
  date_suffix: {
    just: 'åˆšåˆš',
    min: 'åˆ†é’Ÿå‰',
    hour: 'å°æ—¶å‰',
    day: 'å¤©å‰',
    month: 'ä¸ªæœˆå‰'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"ä½ å·²åˆ‡æ¢ä¸ºç¹ä½“","cht_to_chs":"ä½ å·²åˆ‡æ¢ä¸ºç®€ä½“","day_to_night":"ä½ å·²åˆ‡æ¢ä¸ºæ·±è‰²æ¨¡å¼","night_to_day":"ä½ å·²åˆ‡æ¢ä¸ºæµ…è‰²æ¨¡å¼","bgLight":"#49b1f5","bgDark":"#121212","position":"bottom-left"},
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: true,
  islazyload: false,
  isanchor: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'BERTå®æˆ˜â€”â€”ï¼ˆ7ï¼‰ç”Ÿæˆä»»åŠ¡-è¯­è¨€æ¨¡å‹',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2021-09-04 20:47:02'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    })(window)</script><link rel="stylesheet" href="/css/iconfont.css"><meta name="generator" content="Hexo 5.4.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">åŠ è½½ä¸­...</div></div></div><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src="/img/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">æ–‡ç« </div><div class="length-num">51</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">æ ‡ç­¾</div><div class="length-num">29</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">åˆ†ç±»</div><div class="length-num">5</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> é¦–é¡µ</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-compass"></i><span> åˆ†ç±»</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> æ—¶é—´è½´</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> æ ‡ç­¾</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> ç±»åˆ«</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-star"></i><span> Spark</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> éŸ³ä¹</span></a></li><li><a class="site-page child" href="/gallery/"><i class="fa-fw fas fa-images"></i><span> ç…§ç‰‡</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fas fa-comment-dots"></i><span> ç•™è¨€æ¿</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> å‹é“¾</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-duotone fa-user"></i><span> å…³äº</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/2021/08/26/BERT%E5%AE%9E%E6%88%98%E2%80%94%E2%80%94%EF%BC%881%EF%BC%89%E6%96%87%E6%9C%AC%E5%88%86%E7%B1%BB/huggingFace.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">å†¬äºçš„åšå®¢</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> æœç´¢</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> é¦–é¡µ</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-compass"></i><span> åˆ†ç±»</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> æ—¶é—´è½´</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> æ ‡ç­¾</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> ç±»åˆ«</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-star"></i><span> Spark</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> éŸ³ä¹</span></a></li><li><a class="site-page child" href="/gallery/"><i class="fa-fw fas fa-images"></i><span> ç…§ç‰‡</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fas fa-comment-dots"></i><span> ç•™è¨€æ¿</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> å‹é“¾</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-duotone fa-user"></i><span> å…³äº</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">BERTå®æˆ˜â€”â€”ï¼ˆ7ï¼‰ç”Ÿæˆä»»åŠ¡-è¯­è¨€æ¨¡å‹</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">å‘è¡¨äº</span><time class="post-meta-date-created" datetime="2021-08-31T05:59:23.000Z" title="å‘è¡¨äº 2021-08-31 13:59:23">2021-08-31</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">æ›´æ–°äº</span><time class="post-meta-date-updated" datetime="2021-09-04T12:47:02.698Z" title="æ›´æ–°äº 2021-09-04 20:47:02">2021-09-04</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/">æ·±åº¦å­¦ä¹ </a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">å­—æ•°æ€»è®¡:</span><span class="word-count">3,760</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">é˜…è¯»æ—¶é•¿:</span><span>16åˆ†é’Ÿ</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="BERTå®æˆ˜â€”â€”ï¼ˆ7ï¼‰ç”Ÿæˆä»»åŠ¡-è¯­è¨€æ¨¡å‹"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">é˜…è¯»é‡:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="bertå®æˆ˜7ç”Ÿæˆä»»åŠ¡-è¯­è¨€æ¨¡å‹">BERTå®æˆ˜â€”â€”ï¼ˆ7ï¼‰ç”Ÿæˆä»»åŠ¡-è¯­è¨€æ¨¡å‹</h1>
<h2 id="å¼•è¨€">å¼•è¨€</h2>
<p>ä¹‹å‰çš„åˆ†åˆ«ä»‹ç»äº†ä½¿ç”¨ <a target="_blank" rel="noopener" href="https://github.com/huggingface/transformers">ğŸ¤— Transformers</a>ä»£ç åº“ä¸­çš„æ¨¡å‹å¼€å±•one-classä»»åŠ¡(<a href="https://ifwind.github.io/2021/08/26/BERT%E5%AE%9E%E6%88%98%E2%80%94%E2%80%94%EF%BC%881%EF%BC%89%E6%96%87%E6%9C%AC%E5%88%86%E7%B1%BB/">æ–‡æœ¬åˆ†ç±»</a>ã€<a href="https://ifwind.github.io/2021/08/27/BERT%E5%AE%9E%E6%88%98%E2%80%94%E2%80%94%EF%BC%883%EF%BC%89%E9%97%AE%E7%AD%94%E4%BB%BB%E5%8A%A1-%E5%A4%9A%E9%80%89%E9%97%AE%E7%AD%94/">å¤šé€‰é—®ç­”é—®é¢˜</a>)ã€class for each tokenä»»åŠ¡(<a href="https://ifwind.github.io/2021/08/27/BERT%E5%AE%9E%E6%88%98%E2%80%94%E2%80%94%EF%BC%882%EF%BC%89%E5%BA%8F%E5%88%97%E6%A0%87%E6%B3%A8/">åºåˆ—æ ‡æ³¨</a>)ã€copy from inputä»»åŠ¡(<a href="https://ifwind.github.io/2021/08/30/BERT%E5%AE%9E%E6%88%98%E2%80%94%E2%80%94%EF%BC%884%EF%BC%89%E9%97%AE%E7%AD%94%E4%BB%BB%E5%8A%A1-%E6%8A%BD%E5%8F%96%E5%BC%8F%E9%97%AE%E7%AD%94/">æŠ½å–å¼é—®ç­”</a>)ä»¥åŠgeneral sequenceä»»åŠ¡ï¼ˆæœºå™¨ç¿»è¯‘ã€æ‘˜è¦æŠ½å–ï¼‰ã€‚</p>
<p>è¿™ä¸€ç¯‡å°†ä»‹ç»<strong>å¦‚ä½•ä½¿ç”¨è¯­è¨€æ¨¡å‹ä»»åŠ¡å¾®è°ƒ <a target="_blank" rel="noopener" href="https://github.com/huggingface/transformers">ğŸ¤— Transformers</a>æ¨¡å‹</strong>ï¼ˆå…³äºä»€ä¹ˆæ˜¯è¯­è¨€æ¨¡å‹ï¼Œå›çœ‹<a href="https://ifwind.github.io/2021/08/20/BERT%E7%9B%B8%E5%85%B3%E2%80%94%E2%80%94%EF%BC%881%EF%BC%89%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B/">ä¹‹å‰çš„åšå®¢-è¯­è¨€æ¨¡å‹</a>ï¼‰ã€‚</p>
<h3 id="ä»»åŠ¡ä»‹ç»">ä»»åŠ¡ä»‹ç»</h3>
<p>æˆ‘ä»¬è¿™é‡Œä¸»è¦å®Œæˆä¸¤ç±»è¯­è¨€å»ºæ¨¡ä»»åŠ¡ï¼š</p>
<ul>
<li><strong>å› æœè¯­è¨€æ¨¡å‹ï¼ˆCausal language modelingï¼ŒCLMï¼‰</strong>ï¼š<strong>æ¨¡å‹éœ€è¦é¢„æµ‹å¥å­ä¸­çš„ä¸‹ä¸€ä½ç½®å¤„çš„å­—ç¬¦</strong>ï¼ˆ<strong>ç±»ä¼¼BERTç±»æ¨¡å‹çš„decoderå’ŒGPT</strong>ï¼Œä»å·¦å¾€å³è¾“å…¥å­—ç¬¦ï¼‰ã€‚æ¨¡å‹ä¼šä½¿ç”¨çŸ©é˜µå¯¹è§’çº¿attention maskæœºåˆ¶é˜²æ­¢æ¨¡å‹æå‰çœ‹åˆ°ç­”æ¡ˆã€‚ä¾‹å¦‚ï¼Œå½“æ¨¡å‹è¯•å›¾é¢„æµ‹å¥å­ä¸­çš„<span class="math inline">\(i+1\)</span>ä½ç½®å¤„çš„å­—ç¬¦æ—¶ï¼Œè¿™ä¸ªæ©ç å°†é˜»æ­¢å®ƒè®¿é—®<span class="math inline">\(i\)</span>ä½ç½®ä¹‹åçš„å­—ç¬¦ã€‚</li>
</ul>
<blockquote>
<p><img src="/2021/08/31/BERT%E5%AE%9E%E6%88%98%E2%80%94%E2%80%94%EF%BC%887%EF%BC%89%E7%94%9F%E6%88%90%E4%BB%BB%E5%8A%A1-%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B/image-20210901190347576.png" style="zoom:80%;"></p>
</blockquote>
<ul>
<li><strong>æ©ç è¯­è¨€å»ºæ¨¡ï¼ˆMasked language modelingï¼ŒMLMï¼‰</strong>ï¼šæ¨¡å‹éœ€è¦æ¢å¤è¾“å…¥ä¸­è¢«&quot;MASK&quot;æ‰çš„ä¸€äº›å­—ç¬¦ï¼ˆBERTç±»æ¨¡å‹çš„é¢„è®­ç»ƒä»»åŠ¡ï¼Œåªç”¨transformerçš„encoderéƒ¨åˆ†ï¼‰ã€‚æ¨¡å‹å¯ä»¥çœ‹åˆ°æ•´ä¸ªå¥å­ï¼Œå› æ­¤æ¨¡å‹å¯ä»¥æ ¹æ®â€œ[MASK]â€æ ‡è®°ä¹‹å‰å’Œä¹‹åçš„å­—ç¬¦æ¥é¢„æµ‹è¯¥ä½ç½®è¢«â€œ[MASK]â€ä¹‹å‰çš„å­—ç¬¦ã€‚</li>
</ul>
<blockquote>
<p><img src="/2021/08/31/BERT%E5%AE%9E%E6%88%98%E2%80%94%E2%80%94%EF%BC%887%EF%BC%89%E7%94%9F%E6%88%90%E4%BB%BB%E5%8A%A1-%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B/masked_language_modeling.png" style="zoom:80%;"></p>
</blockquote>
<p>ä¸»è¦åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†ï¼š</p>
<ol type="1">
<li>æ•°æ®åŠ è½½ï¼›</li>
<li>æ•°æ®é¢„å¤„ç†ï¼›</li>
<li>å¾®è°ƒé¢„è®­ç»ƒæ¨¡å‹ï¼šä½¿ç”¨transformerä¸­çš„<strong><code>Seq2SeqTrainer</code>æ¥å£</strong>å¯¹é¢„è®­ç»ƒæ¨¡å‹è¿›è¡Œå¾®è°ƒï¼ˆæ³¨æ„è¿™é‡Œæ˜¯<code>Seq2SeqTrainer</code>æ¥å£ï¼Œä¹‹å‰çš„ä»»åŠ¡éƒ½æ˜¯è°ƒç”¨<code>Trainer</code>æ¥å£ï¼‰ã€‚</li>
</ol>
<h3 id="å‰æœŸå‡†å¤‡">å‰æœŸå‡†å¤‡</h3>
<p>å®‰è£…ä»¥ä¸‹åº“ï¼š</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">pip install datasets transformers sacrebleu sentencepiece</span><br><span class="line"><span class="comment">#transformers==4.9.2</span></span><br><span class="line"><span class="comment">#datasets==1.11.0</span></span><br></pre></td></tr></table></figure>
<h2 id="æ•°æ®åŠ è½½">æ•°æ®åŠ è½½</h2>
<h3 id="æ•°æ®é›†ä»‹ç»">æ•°æ®é›†ä»‹ç»</h3>
<p>æˆ‘ä»¬ä½¿ç”¨<a target="_blank" rel="noopener" href="https://huggingface.co/datasets/wikitext#data-instances">Wikitext 2</a>æ•°æ®é›†ï¼Œå…¶ä¸­åŒ…æ‹¬äº†ä»Wikipediaä¸Šç»è¿‡éªŒè¯çš„Goodå’ŒFeaturedæ–‡ç« é›†ä¸­æå–çš„è¶…è¿‡1äº¿ä¸ªtokençš„é›†åˆã€‚</p>
<h3 id="åŠ è½½æ•°æ®">åŠ è½½æ•°æ®</h3>
<p>è¯¥æ•°æ®çš„åŠ è½½æ–¹å¼åœ¨transformersåº“ä¸­è¿›è¡Œäº†å°è£…ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä»¥ä¸‹è¯­å¥è¿›è¡Œæ•°æ®åŠ è½½ï¼š</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> datasets <span class="keyword">import</span> load_dataset</span><br><span class="line">datasets = load_dataset(<span class="string">&#x27;wikitext&#x27;</span>, <span class="string">&#x27;wikitext-2-raw-v1&#x27;</span>)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>å¦‚æœç¢°åˆ°ä»¥ä¸‹é”™è¯¯ï¼š <img src="/2021/08/31/BERT%E5%AE%9E%E6%88%98%E2%80%94%E2%80%94%EF%BC%887%EF%BC%89%E7%94%9F%E6%88%90%E4%BB%BB%E5%8A%A1-%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B/request_error.png" alt="request Error"></p>
<p>è§£å†³æ–¹æ¡ˆ:</p>
<p>MACç”¨æˆ·: åœ¨ <code>/etc/hosts</code> æ–‡ä»¶ä¸­æ·»åŠ ä¸€è¡Œ <code>199.232.68.133  raw.githubusercontent.com</code></p>
<p>Windowsç”¨æˆ·: åœ¨ <code>C:\Windows\System32\drivers\etc\hosts</code> æ–‡ä»¶ä¸­æ·»åŠ ä¸€è¡Œ <code>199.232.68.133  raw.githubusercontent.com</code></p>
</blockquote>
<p>å¦‚æœæƒ³åŠ è½½è‡ªå·±çš„æ•°æ®é›†å¯ä»¥å‚è€ƒ<a href="https://ifwind.github.io/2021/08/26/BERTå®æˆ˜â€”â€”ï¼ˆ1ï¼‰æ–‡æœ¬åˆ†ç±»/#åŠ è½½è‡ªå·±çš„æ•°æ®æˆ–æ¥è‡ªç½‘ç»œçš„æ•°æ®">ä¹‹å‰çš„åšå®¢-å®šä½è¯ï¼šåŠ è½½è‡ªå·±çš„æ•°æ®æˆ–æ¥è‡ªç½‘ç»œçš„æ•°æ®</a>ã€‚</p>
<p>æ•°æ®åŠ è½½å®Œæ¯•åï¼Œç»™å®šä¸€ä¸ªæ•°æ®åˆ‡åˆ†çš„keyï¼ˆtrainã€validationæˆ–è€…testï¼‰å’Œä¸‹æ ‡å³å¯æŸ¥çœ‹æ•°æ®ã€‚</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">datasets[<span class="string">&quot;train&quot;</span>][<span class="number">10</span>]</span><br><span class="line"><span class="comment">#&#123;&#x27;text&#x27;: &#x27; The game \&#x27;s battle system , the BliTZ system , is carried over directly from Valkyira Chronicles . During missions , players select each unit using a top @-@ down perspective of the battlefield map : once a character is selected , the player moves the character around the battlefield in third @-@ person . A character can only act once per @-@ turn , but characters can be granted multiple turns at the expense of other characters \&#x27; turns . Each character has a field and distance of movement limited by their Action Gauge . Up to nine characters can be assigned to a single mission . During gameplay , characters will call out if something happens to them , such as their health points ( HP ) getting low or being knocked out by enemy attacks . Each character has specific &quot; Potentials &quot; , skills unique to each character . They are divided into &quot; Personal Potential &quot; , which are innate skills that remain unaltered unless otherwise dictated by the story and can either help or impede a character , and &quot; Battle Potentials &quot; , which are grown throughout the game and always grant boons to a character . To learn Battle Potentials , each character has a unique &quot; Masters Table &quot; , a grid @-@ based skill table that can be used to acquire and link different skills . Characters also have Special Abilities that grant them temporary boosts on the battlefield : Kurt can activate &quot; Direct Command &quot; and move around the battlefield without depleting his Action Point gauge , the character Reila can shift into her &quot; Valkyria Form &quot; and become invincible , while Imca can target multiple enemy units with her heavy weapon . \n&#x27;&#125;</span></span><br></pre></td></tr></table></figure>
<p>ä¸‹é¢çš„å‡½æ•°å°†ä»æ•°æ®é›†é‡Œéšæœºé€‰æ‹©å‡ ä¸ªä¾‹å­è¿›è¡Œå±•ç¤ºï¼Œå¯ä»¥çœ‹åˆ°ä¸€äº›æ–‡æœ¬æ˜¯ç»´åŸºç™¾ç§‘æ–‡ç« çš„å®Œæ•´æ®µè½ï¼Œè€Œå…¶ä»–çš„åªæ˜¯æ ‡é¢˜æˆ–ç©ºè¡Œã€‚</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> datasets <span class="keyword">import</span> ClassLabel</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">from</span> IPython.display <span class="keyword">import</span> display, HTML</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show_random_elements</span>(<span class="params">dataset, num_examples=<span class="number">4</span></span>):</span></span><br><span class="line">    <span class="keyword">assert</span> num_examples &lt;= <span class="built_in">len</span>(dataset), <span class="string">&quot;Can&#x27;t pick more elements than there are in the dataset.&quot;</span></span><br><span class="line">    picks = []</span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(num_examples):</span><br><span class="line">        pick = random.randint(<span class="number">0</span>, <span class="built_in">len</span>(dataset)-<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">while</span> pick <span class="keyword">in</span> picks:</span><br><span class="line">            pick = random.randint(<span class="number">0</span>, <span class="built_in">len</span>(dataset)-<span class="number">1</span>)</span><br><span class="line">        picks.append(pick)</span><br><span class="line">    </span><br><span class="line">    df = pd.DataFrame(dataset[picks])</span><br><span class="line">    <span class="keyword">for</span> column, typ <span class="keyword">in</span> dataset.features.items():</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(typ, ClassLabel):</span><br><span class="line">            df[column] = df[column].transform(<span class="keyword">lambda</span> i: typ.names[i])</span><br><span class="line">    display(HTML(df.to_html()))</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">show_random_elements(raw_datasets[<span class="string">&quot;train&quot;</span>])</span><br></pre></td></tr></table></figure>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th>
</th>
<th>
text
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
0
</th>
<td>
MD 194D is the designation for an unnamed 0 @.@ 02 @-@ mile ( 0 @.@ 032 km ) connector between MD 194 and MD 853E , the old alignment that parallels the northbound direction of the modern highway south of Angell Road . 
</td>
</tr>
<tr>
<th>
1
</th>
<td>
My sense , as though of hemlock I had drunk , 
</td>
</tr>
<tr>
<th>
2
</th>
<td>
</td>
</tr>
<tr>
<th>
3
</th>
<td>
A mimed stage show , Thunderbirds : F.A.B. , has toured internationally and popularised a staccato style of movement known colloquially as the &quot; Thunderbirds walk &quot; . The production has periodically been revived as Thunderbirds : F.A.B. â€“ The Next Generation . 
</td>
</tr>
</tbody>
</table>
<h2 id="å› æœè¯­è¨€æ¨¡å‹causal-language-modelingclm">å› æœè¯­è¨€æ¨¡å‹ï¼ˆCausal Language Modelingï¼ŒCLMï¼‰</h2>
<h3 id="æ•°æ®é¢„å¤„ç†">æ•°æ®é¢„å¤„ç†</h3>
<p>åœ¨å°†æ•°æ®å–‚å…¥æ¨¡å‹ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å¯¹æ•°æ®è¿›è¡Œé¢„å¤„ç†ã€‚</p>
<p>ä»ç„¶æ˜¯ä¸¤ä¸ªæ•°æ®é¢„å¤„ç†çš„åŸºæœ¬æµç¨‹ï¼š</p>
<ol type="1">
<li>åˆ†è¯ï¼›</li>
<li>è½¬åŒ–æˆå¯¹åº”ä»»åŠ¡è¾“å…¥æ¨¡å‹çš„æ ¼å¼ï¼›</li>
</ol>
<p><code>Tokenizer</code>ç”¨äºä¸Šé¢ä¸¤æ­¥æ•°æ®é¢„å¤„ç†å·¥ä½œï¼š<code>Tokenizer</code>é¦–å…ˆå¯¹è¾“å…¥è¿›è¡Œtokenizeï¼Œç„¶åå°†tokensè½¬åŒ–ä¸ºé¢„æ¨¡å‹ä¸­éœ€è¦å¯¹åº”çš„token IDï¼Œå†è½¬åŒ–ä¸ºæ¨¡å‹éœ€è¦çš„è¾“å…¥æ ¼å¼ã€‚</p>
<h4 id="åˆå§‹åŒ–tokenizer">åˆå§‹åŒ–Tokenizer</h4>
<p><a href="https://ifwind.github.io/2021/08/26/BERT%E5%AE%9E%E6%88%98%E2%80%94%E2%80%94%EF%BC%881%EF%BC%89%E6%96%87%E6%9C%AC%E5%88%86%E7%B1%BB/#%E5%88%9D%E5%A7%8B%E5%8C%96Tokenizer">ä¹‹å‰çš„åšå®¢</a>å·²ç»ä»‹ç»äº†ä¸€äº›Tokenizerçš„å†…å®¹ï¼Œå¹¶åšäº†Tokenizeråˆ†è¯çš„ç¤ºä¾‹ï¼Œè¿™é‡Œä¸å†é‡å¤ã€‚<code>use_fast=True</code>æŒ‡å®šä½¿ç”¨fastç‰ˆæœ¬çš„tokenizerã€‚æˆ‘ä»¬ä½¿ç”¨å·²ç»è®­ç»ƒå¥½çš„<a target="_blank" rel="noopener" href="https://huggingface.co/distilgpt2"><code>distilgpt2</code></a> æ¨¡å‹checkpointæ¥åšè¯¥ä»»åŠ¡ã€‚</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> transformers <span class="keyword">import</span> AutoTokenizer</span><br><span class="line">model_checkpoint = <span class="string">&quot;distilgpt2&quot;</span></span><br><span class="line">tokenizer = AutoTokenizer.from_pretrained(model_checkpoint, use_fast=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>
<h4 id="è½¬åŒ–æˆå¯¹åº”ä»»åŠ¡è¾“å…¥æ¨¡å‹çš„æ ¼å¼">è½¬åŒ–æˆå¯¹åº”ä»»åŠ¡è¾“å…¥æ¨¡å‹çš„æ ¼å¼</h4>
<p>å¯¹äºå› æœè¯­è¨€æ¨¡å‹(CLM)ï¼Œæˆ‘ä»¬é¦–å…ˆè·å–åˆ°æ•°æ®é›†ä¸­çš„æ‰€æœ‰æ–‡æœ¬å¹¶åˆ†è¯ï¼Œä¹‹åå°†å®ƒä»¬è¿æ¥èµ·æ¥ã€‚æœ€åï¼Œåœ¨ç‰¹å®šåºåˆ—é•¿åº¦çš„ä¾‹å­ä¸­æ‹†åˆ†å®ƒä»¬ï¼Œå°†å„ä¸ªæ‹†åˆ†éƒ¨åˆ†ä½œä¸ºæ¨¡å‹è¾“å…¥ã€‚</p>
<p>é€šè¿‡è¿™ç§æ–¹å¼ï¼Œæ¨¡å‹å°†æ¥æ”¶å¦‚ä¸‹çš„è¿ç»­æ–‡æœ¬å—ï¼Œ<code>[BOS_TOKEN]</code>ç”¨äºåˆ†å‰²æ‹¼æ¥äº†æ¥è‡ªä¸åŒå†…å®¹çš„æ–‡æœ¬ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">è¾“å…¥ç±»å‹1ï¼šæ–‡æœ¬1</span><br><span class="line">è¾“å…¥ç±»å‹2ï¼šæ–‡æœ¬1ç»“å°¾ [BOS_TOKEN] æ–‡æœ¬2å¼€å¤´</span><br></pre></td></tr></table></figure>
<h5 id="è°ƒç”¨åˆ†è¯å™¨å¯¹æ‰€æœ‰çš„æ–‡æœ¬åˆ†è¯">è°ƒç”¨åˆ†è¯å™¨å¯¹æ‰€æœ‰çš„æ–‡æœ¬åˆ†è¯</h5>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">tokenize_function</span>(<span class="params">examples</span>):</span></span><br><span class="line">    <span class="keyword">return</span> tokenizer(examples[<span class="string">&quot;text&quot;</span>])</span><br></pre></td></tr></table></figure>
<p><strong>ä½¿ç”¨mapå‡½æ•°</strong>å¯¹æ•°æ®é›†<strong>datasetsé‡Œé¢ä¸‰ä¸ªæ ·æœ¬é›†åˆçš„æ‰€æœ‰æ ·æœ¬è¿›è¡Œé¢„å¤„ç†ï¼Œ</strong>å°†å‡½æ•°<code>tokenize_function</code>åº”ç”¨åˆ°ï¼ˆmap)æ‰€æœ‰æ ·æœ¬ä¸Šã€‚ä½¿ç”¨<code>batch=True</code>å’Œ<code>4</code>ä¸ªè¿›ç¨‹æ¥åŠ é€Ÿé¢„å¤„ç†ã€‚è¿™æ˜¯ä¸ºäº†å……åˆ†åˆ©ç”¨å‰é¢åŠ è½½fast_tokenizerçš„ä¼˜åŠ¿ï¼Œå®ƒå°†ä½¿ç”¨å¤šçº¿ç¨‹å¹¶å‘åœ°å¤„ç†æ‰¹ä¸­çš„æ–‡æœ¬ã€‚ä¹‹åæˆ‘ä»¬å¹¶ä¸éœ€è¦<code>text</code>åˆ—ï¼Œæ‰€ä»¥å°†å…¶èˆå¼ƒï¼ˆ<code>remove_columns</code>ï¼‰ã€‚</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">tokenized_datasets = datasets.<span class="built_in">map</span>(tokenize_function, batched=<span class="literal">True</span>, num_proc=<span class="number">4</span>, remove_columns=[<span class="string">&quot;text&quot;</span>])</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬ç°åœ¨æŸ¥çœ‹æ•°æ®é›†çš„ä¸€ä¸ªå…ƒç´ ï¼Œè®­ç»ƒé›†ä¸­<code>text</code>å·²ç»è¢«æ¨¡å‹æ‰€éœ€çš„<code>input_ids</code>æ‰€å–ä»£:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">tokenized_datasets[<span class="string">&quot;train&quot;</span>][<span class="number">1</span>]</span><br><span class="line"><span class="comment">#&#123;&#x27;attention_mask&#x27;: [1, 1, 1, 1, 1, 1, 1, 1, 1],</span></span><br><span class="line"><span class="comment"># &#x27;input_ids&#x27;: [796, 569, 18354, 7496, 17740, 6711, 796, 220, 198]&#125;</span></span><br></pre></td></tr></table></figure>
<h5 id="æ‹¼æ¥æ–‡æœ¬æŒ‰å®šé•¿æ‹†åˆ†æ–‡æœ¬">æ‹¼æ¥æ–‡æœ¬&amp;æŒ‰å®šé•¿æ‹†åˆ†æ–‡æœ¬</h5>
<p>æˆ‘ä»¬éœ€è¦å°†æ‰€æœ‰æ–‡æœ¬è¿æ¥åœ¨ä¸€èµ·ï¼Œç„¶åå°†ç»“æœåˆ†å‰²æˆç‰¹å®š<code>block_size</code>çš„å°å—ã€‚<code>block_size</code>è®¾ç½®ä¸ºé¢„è®­ç»ƒæ¨¡å‹æ—¶æ‰€ä½¿ç”¨çš„æœ€å¤§é•¿åº¦ã€‚</p>
<p>ç¼–å†™é¢„å¤„ç†å‡½æ•°æ¥å¯¹æ–‡æœ¬è¿›è¡Œç»„åˆå’Œæ‹†åˆ†ï¼š</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># block_size = tokenizer.model_max_length</span></span><br><span class="line">block_size = <span class="number">128</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">group_texts</span>(<span class="params">examples</span>):</span></span><br><span class="line">    <span class="comment"># æ‹¼æ¥æ‰€æœ‰æ–‡æœ¬</span></span><br><span class="line">    concatenated_examples = &#123;k: <span class="built_in">sum</span>(examples[k], []) <span class="keyword">for</span> k <span class="keyword">in</span> examples.keys()&#125;</span><br><span class="line">    total_length = <span class="built_in">len</span>(concatenated_examples[<span class="built_in">list</span>(examples.keys())[<span class="number">0</span>]])</span><br><span class="line">    <span class="comment"># æˆ‘ä»¬å°†ä½™æ•°å¯¹åº”çš„éƒ¨åˆ†å»æ‰ã€‚ä½†å¦‚æœæ¨¡å‹æ”¯æŒçš„è¯ï¼Œå¯ä»¥æ·»åŠ paddingï¼Œæ‚¨å¯ä»¥æ ¹æ®éœ€è¦å®šåˆ¶æ­¤éƒ¨ä»¶ã€‚</span></span><br><span class="line">    total_length = (total_length // block_size) * block_size</span><br><span class="line">    <span class="comment"># é€šè¿‡max_lenè¿›è¡Œåˆ†å‰²ã€‚</span></span><br><span class="line">    result = &#123;</span><br><span class="line">        k: [t[i : i + block_size] <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, total_length, block_size)]</span><br><span class="line">        <span class="keyword">for</span> k, t <span class="keyword">in</span> concatenated_examples.items()</span><br><span class="line">    &#125;</span><br><span class="line">    result[<span class="string">&quot;labels&quot;</span>] = result[<span class="string">&quot;input_ids&quot;</span>].copy()</span><br><span class="line">    <span class="keyword">return</span> result</span><br></pre></td></tr></table></figure>
<p><strong>æ³¨æ„ï¼šå› ä¸ºæˆ‘ä»¬åšçš„æ˜¯å› æœè¯­è¨€æ¨¡å‹ï¼Œå…¶é¢„æµ‹labelå°±æ˜¯å…¶è¾“å…¥çš„input_idï¼Œæ‰€ä»¥æˆ‘ä»¬å¤åˆ¶äº†æ ‡ç­¾çš„è¾“å…¥ã€‚</strong></p>
<p>æˆ‘ä»¬å°†å†æ¬¡ä½¿ç”¨<code>map</code>æ–¹æ³•ï¼Œ<code>batched=True</code>è¡¨ç¤ºå…è®¸é€šè¿‡è¿”å›ä¸åŒæ•°é‡çš„æ ·æœ¬æ¥æ”¹å˜æ•°æ®é›†ä¸­çš„æ ·æœ¬æ•°é‡ï¼Œè¿™æ ·å¯ä»¥ä»ä¸€æ‰¹ç¤ºä¾‹ä¸­åˆ›å»ºæ–°çš„ç¤ºä¾‹ã€‚</p>
<p>æ³¨æ„ï¼Œåœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œ<code>map</code>æ–¹æ³•å°†å‘é€ä¸€æ‰¹1,000ä¸ªç¤ºä¾‹ï¼Œç”±é¢„å¤„ç†å‡½æ•°å¤„ç†ã€‚<strong>å¯ä»¥é€šè¿‡ä¼ é€’ä¸åŒbatch_sizeæ¥è°ƒæ•´ã€‚ä¹Ÿå¯ä»¥ä½¿ç”¨<code>num_proc</code>æ¥åŠ é€Ÿé¢„å¤„ç†ã€‚</strong></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">lm_datasets = tokenized_datasets.<span class="built_in">map</span>(</span><br><span class="line">    group_texts,</span><br><span class="line">    batched=<span class="literal">True</span>,</span><br><span class="line">    batch_size=<span class="number">1000</span>,</span><br><span class="line">    num_proc=<span class="number">4</span>,</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>æ£€æŸ¥ä¸€ä¸‹æ•°æ®é›†æ˜¯å¦å‘ç”Ÿäº†å˜åŒ–ï¼š</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">tokenizer.decode(lm_datasets[<span class="string">&quot;train&quot;</span>][<span class="number">1</span>][<span class="string">&quot;input_ids&quot;</span>])</span><br></pre></td></tr></table></figure>
<p>ç°åœ¨æ ·æœ¬åŒ…å«äº†<code>block_size</code>å¤§å°çš„è¿ç»­å­—ç¬¦å—ï¼Œå¯èƒ½è·¨è¶Šäº†å‡ ä¸ªåŸå§‹æ–‡æœ¬ã€‚</p>
<p>' game and follows the &quot; Nameless &quot;, a penal military unit serving the nation of Gallia during the Second Europan War who perform secret black operations and are pitted against the Imperial unit &quot; Calamaty Raven &quot;. The game began development in 2010, carrying over a large portion of the work done on Valkyria Chronicles II. While it retained the standard features of the series, it also underwent multiple adjustments, such as making the game more forgiving for series newcomers. Character designer Raita Honjou and composer Hitoshi Sakimoto both returned from previous entries, along with Valkyria Chronicles II director Takeshi Oz'</p>
<h3 id="å¾®è°ƒé¢„è®­ç»ƒæ¨¡å‹">å¾®è°ƒé¢„è®­ç»ƒæ¨¡å‹</h3>
<p>æ•°æ®å·²ç»å‡†å¤‡å¥½äº†ï¼Œæˆ‘ä»¬éœ€è¦ä¸‹è½½å¹¶åŠ è½½é¢„è®­ç»ƒæ¨¡å‹ï¼Œç„¶åå¾®è°ƒé¢„è®­ç»ƒæ¨¡å‹ã€‚</p>
<h4 id="åŠ è½½é¢„è®­ç»ƒæ¨¡å‹">åŠ è½½é¢„è®­ç»ƒæ¨¡å‹</h4>
<p>åš<strong>å› æœè¯­è¨€æ¨¡å‹ä»»åŠ¡ï¼Œé‚£ä¹ˆéœ€è¦ä¸€ä¸ªèƒ½è§£å†³è¿™ä¸ªä»»åŠ¡çš„æ¨¡å‹ç±»ã€‚æˆ‘ä»¬ä½¿ç”¨<code>AutoModelForCausalLM</code> è¿™ä¸ªç±»</strong>ã€‚</p>
<p>å’Œä¹‹å‰å‡ ç¯‡åšå®¢æåˆ°çš„åŠ è½½æ–¹å¼ç›¸åŒä¸å†èµ˜è¿°ã€‚</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> transformers <span class="keyword">import</span> AutoModelForCausalLM</span><br><span class="line">model = AutoModelForCausalLM.from_pretrained(model_checkpoint)</span><br></pre></td></tr></table></figure>
<h4 id="è®¾å®šè®­ç»ƒå‚æ•°">è®¾å®šè®­ç»ƒå‚æ•°</h4>
<p>ä¸ºäº†èƒ½å¤Ÿå¾—åˆ°ä¸€ä¸ª<strong><code>Trainer</code>è®­ç»ƒå·¥å…·</strong>ï¼Œæˆ‘ä»¬è¿˜éœ€è¦<strong>è®­ç»ƒçš„è®¾å®š/å‚æ•° <a target="_blank" rel="noopener" href="https://huggingface.co/transformers/main_classes/trainer.html#transformers.TrainingArguments"><code>TrainingArguments</code></a>ã€‚è¿™ä¸ªè®­ç»ƒè®¾å®šåŒ…å«äº†èƒ½å¤Ÿå®šä¹‰è®­ç»ƒè¿‡ç¨‹çš„æ‰€æœ‰å±æ€§</strong>ã€‚</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> transformers <span class="keyword">import</span> TrainingArguments</span><br><span class="line">batch_size = <span class="number">16</span></span><br><span class="line">training_args = TrainingArguments(</span><br><span class="line">    <span class="string">&quot;test-clm&quot;</span>,</span><br><span class="line">    evaluation_strategy = <span class="string">&quot;epoch&quot;</span>,</span><br><span class="line">    learning_rate=<span class="number">2e-5</span>,</span><br><span class="line">    weight_decay=<span class="number">0.01</span>,</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<h4 id="å®šä¹‰è¯„ä¼°æ–¹æ³•">å®šä¹‰è¯„ä¼°æ–¹æ³•</h4>
<p>å®Œæˆè¯¥ä»»åŠ¡ä¸éœ€è¦ç‰¹åˆ«å®šä¹‰è¯„ä¼°æŒ‡æ ‡å¤„ç†å‡½æ•°ï¼Œæ¨¡å‹å°†ç›´æ¥è®¡ç®—å›°æƒ‘åº¦perplexityä½œä¸ºè¯„ä¼°æŒ‡æ ‡ã€‚</p>
<h4 id="å¼€å§‹è®­ç»ƒ">å¼€å§‹è®­ç»ƒ</h4>
<p>å°†æ•°æ®/æ¨¡å‹/å‚æ•°ä¼ å…¥<code>Trainer</code>å³å¯ï¼š</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> transformers <span class="keyword">import</span> Trainer</span><br><span class="line">trainer = Trainer(</span><br><span class="line">    model=model,</span><br><span class="line">    args=training_args,</span><br><span class="line">    train_dataset=lm_datasets[<span class="string">&quot;train&quot;</span>][:<span class="number">1000</span>],</span><br><span class="line">    eval_dataset=lm_datasets[<span class="string">&quot;validation&quot;</span>][:<span class="number">1000</span>],</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>è°ƒç”¨<code>train</code>æ–¹æ³•å¼€å§‹è®­ç»ƒï¼š</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">trainer.train()</span><br></pre></td></tr></table></figure>
<h3 id="è¯„ä¼°æ¨¡å‹">è¯„ä¼°æ¨¡å‹</h3>
<p>ä¸€æ—¦è®­ç»ƒå®Œæˆï¼Œæˆ‘ä»¬å°±å¯ä»¥è¯„ä¼°æ¨¡å‹ï¼Œå¾—åˆ°å®ƒåœ¨éªŒè¯é›†ä¸Šçš„perplexityï¼Œå¦‚ä¸‹æ‰€ç¤º:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> math</span><br><span class="line">eval_results = trainer.evaluate()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;Perplexity: <span class="subst">&#123;math.exp(eval_results[<span class="string">&#x27;eval_loss&#x27;</span>]):<span class="number">.2</span>f&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>
<h2 id="æ©ç è¯­è¨€æ¨¡å‹mask-language-modelingmlm">æ©ç è¯­è¨€æ¨¡å‹ï¼ˆMask Language Modelingï¼ŒMLMï¼‰</h2>
<p>æ©ç è¯­è¨€æ¨¡å‹ç›¸æ¯”å› æœè¯­è¨€æ¨¡å‹å¥½è®­ç»ƒå¾—å¤šï¼Œå› ä¸ºåªéœ€è¦å¯¹maskçš„token(æ¯”å¦‚åªå æ€»æ•°çš„15%)è¿›è¡Œé¢„æµ‹ï¼ŒåŒæ—¶å¯ä»¥è®¿é—®å…¶ä½™çš„tokenã€‚å¯¹äºæ¨¡å‹æ¥è¯´ï¼Œè¿™æ˜¯ä¸€é¡¹æ›´å®¹æ˜“çš„ä»»åŠ¡ã€‚</p>
<h3 id="æ•°æ®é¢„å¤„ç†-1">æ•°æ®é¢„å¤„ç†</h3>
<p>å’Œå‰é¢çš„æ­¥éª¤ç›¸åŒï¼š</p>
<ol type="1">
<li>åˆ†è¯ï¼›</li>
<li>è½¬åŒ–æˆå¯¹åº”ä»»åŠ¡è¾“å…¥æ¨¡å‹çš„æ ¼å¼ï¼›</li>
</ol>
<h4 id="åˆå§‹åŒ–tokenizer-1">åˆå§‹åŒ–Tokenizer</h4>
<p>æˆ‘ä»¬ä½¿ç”¨å·²ç»è®­ç»ƒå¥½çš„<a target="_blank" rel="noopener" href="https://huggingface.co/distilroberta-base"><code>distilroberta-base</code></a>æ¨¡å‹checkpointæ¥åšè¯¥ä»»åŠ¡ã€‚</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> transformers <span class="keyword">import</span> AutoTokenizer</span><br><span class="line">model_checkpoint = <span class="string">&quot;distilroberta-base&quot;</span></span><br><span class="line">tokenizer = AutoTokenizer.from_pretrained(model_checkpoint, use_fast=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>
<h4 id="è½¬åŒ–æˆå¯¹åº”ä»»åŠ¡è¾“å…¥æ¨¡å‹çš„æ ¼å¼-1">è½¬åŒ–æˆå¯¹åº”ä»»åŠ¡è¾“å…¥æ¨¡å‹çš„æ ¼å¼</h4>
<p>å¯¹äº<strong>æ©ç è¯­è¨€æ¨¡å‹(MLM)</strong>ï¼Œæˆ‘ä»¬é¦–å…ˆè·å–åˆ°æ•°æ®é›†ä¸­çš„æ‰€æœ‰æ–‡æœ¬å¹¶åˆ†è¯ï¼Œä¹‹åå°†å®ƒä»¬è¿æ¥èµ·æ¥ï¼Œæ¥ç€åœ¨ç‰¹å®šåºåˆ—é•¿åº¦çš„ä¾‹å­ä¸­æ‹†åˆ†å®ƒä»¬ã€‚ä¸å› æœè¯­è¨€æ¨¡å‹ä¸åŒçš„æ˜¯ï¼Œæˆ‘ä»¬<strong>åœ¨æ‹†åˆ†åè¿˜éœ€è¦éšæœº&quot;MASK&quot;ä¸€äº›å­—ç¬¦(ä½¿ç”¨&quot;[MASK]&quot;è¿›è¡Œæ›¿æ¢)ä»¥åŠè°ƒæ•´æ ‡ç­¾ä¸ºåªåŒ…å«åœ¨&quot;[MASK]&quot;ä½ç½®å¤„çš„æ ‡ç­¾(å› ä¸ºæˆ‘ä»¬ä¸éœ€è¦é¢„æµ‹æ²¡æœ‰è¢«&quot;MASK&quot;çš„å­—ç¬¦)</strong>ï¼Œæœ€åå°†å„ä¸ªç»æ©ç çš„æ‹†åˆ†éƒ¨åˆ†ä½œä¸ºæ¨¡å‹è¾“å…¥ã€‚</p>
<h5 id="è°ƒç”¨åˆ†è¯å™¨å¯¹æ‰€æœ‰çš„æ–‡æœ¬åˆ†è¯-1">è°ƒç”¨åˆ†è¯å™¨å¯¹æ‰€æœ‰çš„æ–‡æœ¬åˆ†è¯</h5>
<p>åº”ç”¨ä¸€ä¸ªå’Œå‰é¢ç›¸åŒçš„åˆ†è¯å™¨å‡½æ•°ï¼Œåªéœ€è¦æ›´æ–°åˆ†è¯å™¨æ¥ä½¿ç”¨åˆšåˆšé€‰æ‹©çš„checkpointï¼š</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">tokenize_function</span>(<span class="params">examples</span>):</span></span><br><span class="line">    <span class="keyword">return</span> tokenizer(examples[<span class="string">&quot;text&quot;</span>])</span><br></pre></td></tr></table></figure>
<p>åŒæ ·<strong>ä½¿ç”¨mapå‡½æ•°</strong>å¯¹æ•°æ®é›†<strong>datasetsé‡Œé¢ä¸‰ä¸ªæ ·æœ¬é›†åˆçš„æ‰€æœ‰æ ·æœ¬è¿›è¡Œé¢„å¤„ç†ï¼Œ</strong>å°†å‡½æ•°<code>tokenize_function</code>åº”ç”¨åˆ°ï¼ˆmap)æ‰€æœ‰æ ·æœ¬ä¸Šã€‚</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">tokenized_datasets = datasets.<span class="built_in">map</span>(tokenize_function, batched=<span class="literal">True</span>, num_proc=<span class="number">4</span>, remove_columns=[<span class="string">&quot;text&quot;</span>])</span><br></pre></td></tr></table></figure>
<h5 id="æ‹¼æ¥æ–‡æœ¬æŒ‰å®šé•¿æ‹†åˆ†æ–‡æœ¬-1">æ‹¼æ¥æ–‡æœ¬&amp;æŒ‰å®šé•¿æ‹†åˆ†æ–‡æœ¬</h5>
<p>æˆ‘ä»¬éœ€è¦å°†æ‰€æœ‰æ–‡æœ¬è¿æ¥åœ¨ä¸€èµ·ï¼Œç„¶åå°†ç»“æœåˆ†å‰²æˆç‰¹å®š<code>block_size</code>çš„å°å—ã€‚<code>block_size</code>è®¾ç½®ä¸ºé¢„è®­ç»ƒæ¨¡å‹æ—¶æ‰€ä½¿ç”¨çš„æœ€å¤§é•¿åº¦ã€‚</p>
<p>ç¼–å†™é¢„å¤„ç†å‡½æ•°æ¥å¯¹æ–‡æœ¬è¿›è¡Œç»„åˆå’Œæ‹†åˆ†ï¼š</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># block_size = tokenizer.model_max_length</span></span><br><span class="line">block_size = <span class="number">128</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">group_texts</span>(<span class="params">examples</span>):</span></span><br><span class="line">    <span class="comment"># æ‹¼æ¥æ‰€æœ‰æ–‡æœ¬</span></span><br><span class="line">    concatenated_examples = &#123;k: <span class="built_in">sum</span>(examples[k], []) <span class="keyword">for</span> k <span class="keyword">in</span> examples.keys()&#125;</span><br><span class="line">    total_length = <span class="built_in">len</span>(concatenated_examples[<span class="built_in">list</span>(examples.keys())[<span class="number">0</span>]])</span><br><span class="line">    <span class="comment"># æˆ‘ä»¬å°†ä½™æ•°å¯¹åº”çš„éƒ¨åˆ†å»æ‰ã€‚ä½†å¦‚æœæ¨¡å‹æ”¯æŒçš„è¯ï¼Œå¯ä»¥æ·»åŠ paddingï¼Œæ‚¨å¯ä»¥æ ¹æ®éœ€è¦å®šåˆ¶æ­¤éƒ¨ä»¶ã€‚</span></span><br><span class="line">    total_length = (total_length // block_size) * block_size</span><br><span class="line">    <span class="comment"># é€šè¿‡max_lenè¿›è¡Œåˆ†å‰²ã€‚</span></span><br><span class="line">    result = &#123;</span><br><span class="line">        k: [t[i : i + block_size] <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, total_length, block_size)]</span><br><span class="line">        <span class="keyword">for</span> k, t <span class="keyword">in</span> concatenated_examples.items()</span><br><span class="line">    &#125;</span><br><span class="line">    result[<span class="string">&quot;labels&quot;</span>] = result[<span class="string">&quot;input_ids&quot;</span>].copy()</span><br><span class="line">    <span class="keyword">return</span> result</span><br></pre></td></tr></table></figure>
<p><strong>æ³¨æ„ï¼šæˆ‘ä»¬è¿™é‡Œä»ç„¶å¤åˆ¶äº†æ ‡ç­¾çš„è¾“å…¥ä½œä¸ºlabelï¼Œå› ä¸ºæ©ç è¯­è¨€æ¨¡å‹çš„æœ¬è´¨è¿˜æ˜¯é¢„æµ‹åŸæ–‡ï¼Œè€Œæ©ç åœ¨data collatorä¸­é€šè¿‡æ·»åŠ ç‰¹åˆ«çš„å‚æ•°è¿›è¡Œå¤„ç†ï¼Œä¸‹æ–‡ä¼šç€é‡è¯´æ˜</strong>ã€‚</p>
<p>æˆ‘ä»¬å°†å†æ¬¡ä½¿ç”¨<code>map</code>æ–¹æ³•ï¼Œ<code>batched=True</code>è¡¨ç¤ºå…è®¸é€šè¿‡è¿”å›ä¸åŒæ•°é‡çš„æ ·æœ¬æ¥æ”¹å˜æ•°æ®é›†ä¸­çš„æ ·æœ¬æ•°é‡ï¼Œè¿™æ ·å¯ä»¥ä»ä¸€æ‰¹ç¤ºä¾‹ä¸­åˆ›å»ºæ–°çš„ç¤ºä¾‹ã€‚</p>
<p>æ³¨æ„ï¼Œåœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œ<code>map</code>æ–¹æ³•å°†å‘é€ä¸€æ‰¹1,000ä¸ªç¤ºä¾‹ï¼Œç”±é¢„å¤„ç†å‡½æ•°å¤„ç†ã€‚<strong>å¯ä»¥é€šè¿‡ä¼ é€’ä¸åŒbatch_sizeæ¥è°ƒæ•´ã€‚ä¹Ÿå¯ä»¥ä½¿ç”¨<code>num_proc</code>æ¥åŠ é€Ÿé¢„å¤„ç†ã€‚</strong></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">lm_datasets = tokenized_datasets.<span class="built_in">map</span>(</span><br><span class="line">    group_texts,</span><br><span class="line">    batched=<span class="literal">True</span>,</span><br><span class="line">    batch_size=<span class="number">1000</span>,</span><br><span class="line">    num_proc=<span class="number">4</span>,</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<h3 id="å¾®è°ƒé¢„è®­ç»ƒæ¨¡å‹-1">å¾®è°ƒé¢„è®­ç»ƒæ¨¡å‹</h3>
<p>æ•°æ®å·²ç»å‡†å¤‡å¥½äº†ï¼Œæˆ‘ä»¬éœ€è¦ä¸‹è½½å¹¶åŠ è½½é¢„è®­ç»ƒæ¨¡å‹ï¼Œç„¶åå¾®è°ƒé¢„è®­ç»ƒæ¨¡å‹ã€‚</p>
<h4 id="åŠ è½½é¢„è®­ç»ƒæ¨¡å‹-1">åŠ è½½é¢„è®­ç»ƒæ¨¡å‹</h4>
<p>åš<strong>æ©ç è¯­è¨€æ¨¡å‹ä»»åŠ¡ï¼Œé‚£ä¹ˆéœ€è¦ä¸€ä¸ªèƒ½è§£å†³è¿™ä¸ªä»»åŠ¡çš„æ¨¡å‹ç±»ã€‚æˆ‘ä»¬ä½¿ç”¨<code>AutoModelForMaskedLM</code> è¿™ä¸ªç±»</strong>ã€‚</p>
<p>å’Œä¹‹å‰å‡ ç¯‡åšå®¢æåˆ°çš„åŠ è½½æ–¹å¼ç›¸åŒä¸å†èµ˜è¿°ã€‚</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> transformers <span class="keyword">import</span> AutoModelForMaskedLM</span><br><span class="line">model = AutoModelForMaskedLM.from_pretrained(model_checkpoint)</span><br></pre></td></tr></table></figure>
<h4 id="è®¾å®šè®­ç»ƒå‚æ•°-1">è®¾å®šè®­ç»ƒå‚æ•°</h4>
<p>ä¸ºäº†èƒ½å¤Ÿå¾—åˆ°ä¸€ä¸ª<strong><code>Trainer</code>è®­ç»ƒå·¥å…·</strong>ï¼Œæˆ‘ä»¬è¿˜éœ€è¦<strong>è®­ç»ƒçš„è®¾å®š/å‚æ•° <a target="_blank" rel="noopener" href="https://huggingface.co/transformers/main_classes/trainer.html#transformers.TrainingArguments"><code>TrainingArguments</code></a>ã€‚è¿™ä¸ªè®­ç»ƒè®¾å®šåŒ…å«äº†èƒ½å¤Ÿå®šä¹‰è®­ç»ƒè¿‡ç¨‹çš„æ‰€æœ‰å±æ€§</strong>ã€‚</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> transformers <span class="keyword">import</span> TrainingArguments</span><br><span class="line">batch_size = <span class="number">16</span></span><br><span class="line">training_args = TrainingArguments(</span><br><span class="line">    <span class="string">&quot;test-clm&quot;</span>,</span><br><span class="line">    evaluation_strategy = <span class="string">&quot;epoch&quot;</span>,</span><br><span class="line">    learning_rate=<span class="number">2e-5</span>,</span><br><span class="line">    weight_decay=<span class="number">0.01</span>,</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<h3 id="æ•°æ®æ”¶é›†å™¨data-collator">æ•°æ®æ”¶é›†å™¨data collator</h3>
<p>data_collatoræ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œè´Ÿè´£è·å–æ ·æœ¬å¹¶å°†å®ƒä»¬æ‰¹å¤„ç†æˆå¼ é‡ã€‚data_collatorè´Ÿè´£è·å–æ ·æœ¬å¹¶å°†å®ƒä»¬æ‰¹å¤„ç†æˆå¼ é‡ã€‚æ©ç è¯­è¨€æ¨¡å‹ä»»åŠ¡éœ€è¦ä½¿ç”¨ä¸€ä¸ªç‰¹æ®Šçš„data_collatorï¼Œç”¨äºéšæœº&quot;MASK&quot;å¥å­ä¸­çš„tokenã€‚</p>
<p>æ³¨æ„ï¼šæˆ‘ä»¬å¯ä»¥å°†MASKä½œä¸ºé¢„å¤„ç†æ­¥éª¤(<code>tokenizer</code>)è¿›è¡Œå¤„ç†ï¼Œä½†<code>tokenizer</code>åœ¨æ¯ä¸ªé˜¶æ®µå­—ç¬¦æ€»æ˜¯ä»¥ç›¸åŒçš„æ–¹å¼è¢«æ©ç›–ã€‚è€Œé€šè¿‡åœ¨<code>data_collator</code>ä¸­æ‰§è¡Œè¿™ä¸€æ­¥ï¼Œå¯ä»¥ç¡®ä¿<strong>æ¯æ¬¡ç”Ÿæˆæ•°æ®æ—¶éƒ½ä»¥æ–°çš„æ–¹å¼å®Œæˆæ©ç ï¼ˆéšæœºï¼‰ã€‚</strong></p>
<p>ä¸ºäº†å®ç°éšæœºmaskï¼Œ<strong><code>Transformers</code>ä¸ºæ©ç è¯­è¨€æ¨¡å‹æä¾›äº†ä¸€ä¸ªç‰¹æ®Šçš„<code>DataCollatorForLanguageModeling</code>ã€‚</strong>å¯ä»¥é€šè¿‡<code>mlm_probability</code>è°ƒæ•´æ©ç çš„æ¦‚ç‡ï¼š</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> transformers <span class="keyword">import</span> DataCollatorForLanguageModeling</span><br><span class="line">data_collator = DataCollatorForLanguageModeling(tokenizer=tokenizer, mlm_probability=<span class="number">0.15</span>)</span><br></pre></td></tr></table></figure>
<h4 id="å®šä¹‰è¯„ä¼°æ–¹æ³•-1">å®šä¹‰è¯„ä¼°æ–¹æ³•</h4>
<p>å®Œæˆè¯¥ä»»åŠ¡ä¸éœ€è¦ç‰¹åˆ«å®šä¹‰è¯„ä¼°æŒ‡æ ‡å¤„ç†å‡½æ•°ï¼Œæ¨¡å‹å°†ç›´æ¥è®¡ç®—å›°æƒ‘åº¦perplexityä½œä¸ºè¯„ä¼°æŒ‡æ ‡ã€‚</p>
<h4 id="å¼€å§‹è®­ç»ƒ-1">å¼€å§‹è®­ç»ƒ</h4>
<p>å°†æ•°æ®/æ¨¡å‹/å‚æ•°ä¼ å…¥<code>Trainer</code>å³å¯ï¼š</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> transformers <span class="keyword">import</span> Trainer</span><br><span class="line">trainer = Trainer(</span><br><span class="line">    model=model,</span><br><span class="line">    args=training_args,</span><br><span class="line">    train_dataset=lm_datasets[<span class="string">&quot;train&quot;</span>][:<span class="number">1000</span>],</span><br><span class="line">    eval_dataset=lm_datasets[<span class="string">&quot;validation&quot;</span>][:<span class="number">100</span>],</span><br><span class="line">    data_collator=data_collator,</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>è°ƒç”¨<code>train</code>æ–¹æ³•å¼€å§‹è®­ç»ƒï¼š</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">trainer.train()</span><br></pre></td></tr></table></figure>
<h3 id="è¯„ä¼°æ¨¡å‹-1">è¯„ä¼°æ¨¡å‹</h3>
<p>è®­ç»ƒå®Œæˆåå°±å¯ä»¥è¯„ä¼°æ¨¡å‹ï¼Œå¾—åˆ°å®ƒåœ¨éªŒè¯é›†ä¸Šçš„perplexityï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> math</span><br><span class="line">eval_results = trainer.evaluate()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;Perplexity: <span class="subst">&#123;math.exp(eval_results[<span class="string">&#x27;eval_loss&#x27;</span>]):<span class="number">.2</span>f&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>
<h2 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®</h2>
<p><a target="_blank" rel="noopener" href="https://github.com/datawhalechina/learn-nlp-with-transformers/blob/main/docs/ç¯‡ç« 4-ä½¿ç”¨Transformersè§£å†³NLPä»»åŠ¡/4.5-ç”Ÿæˆä»»åŠ¡-è¯­è¨€æ¨¡å‹.md">4.5-ç”Ÿæˆä»»åŠ¡-è¯­è¨€æ¨¡å‹.md</a></p>
<p><a target="_blank" rel="noopener" href="https://huggingface.co/transformers">transformerså®˜æ–¹æ–‡æ¡£</a></p>
<p><a href="https://ifwind.github.io/2021/08/26/BERTå®æˆ˜â€”â€”ï¼ˆ1ï¼‰æ–‡æœ¬åˆ†ç±»/#åŠ è½½è‡ªå·±çš„æ•°æ®æˆ–æ¥è‡ªç½‘ç»œçš„æ•°æ®">BERTå®æˆ˜â€”â€”ï¼ˆ1ï¼‰æ–‡æœ¬åˆ†ç±» | å†¬äºçš„åšå®¢ (ifwind.github.io)</a></p>
<p><a href="https://ifwind.github.io/2021/08/20/BERTç›¸å…³â€”â€”ï¼ˆ1ï¼‰è¯­è¨€æ¨¡å‹/">BERTç›¸å…³â€”â€”ï¼ˆ1ï¼‰è¯­è¨€æ¨¡å‹</a></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">æ–‡ç« ä½œè€…: </span><span class="post-copyright-info"><a href="mailto:undefined">å†¬äº</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">æ–‡ç« é“¾æ¥: </span><span class="post-copyright-info"><a href="https://ifwind.github.io/2021/08/31/BERT%E5%AE%9E%E6%88%98%E2%80%94%E2%80%94%EF%BC%887%EF%BC%89%E7%94%9F%E6%88%90%E4%BB%BB%E5%8A%A1-%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B/">https://ifwind.github.io/2021/08/31/BERT%E5%AE%9E%E6%88%98%E2%80%94%E2%80%94%EF%BC%887%EF%BC%89%E7%94%9F%E6%88%90%E4%BB%BB%E5%8A%A1-%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">ç‰ˆæƒå£°æ˜: </span><span class="post-copyright-info">æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜æ¥è‡ª <a href="https://ifwind.github.io" target="_blank">å†¬äºçš„åšå®¢</a>ï¼</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/">æ·±åº¦å­¦ä¹ </a><a class="post-meta__tags" href="/tags/BERT/">BERT</a><a class="post-meta__tags" href="/tags/NLP/">NLP</a></div><div class="post_share"><div class="social-share" data-image="/2021/08/26/BERT%E5%AE%9E%E6%88%98%E2%80%94%E2%80%94%EF%BC%881%EF%BC%89%E6%96%87%E6%9C%AC%E5%88%86%E7%B1%BB/huggingFace.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2021/09/22/%E6%9D%8E%E5%AE%8F%E6%AF%85%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A02021%E6%98%A5p5-9%EF%BC%9A%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E8%AE%AD%E7%BB%83%E6%8A%80%E5%B7%A7/"><img class="prev-cover" src="/2021/09/22/%E6%9D%8E%E5%AE%8F%E6%AF%85%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A02021%E6%98%A5p5-9%EF%BC%9A%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E8%AE%AD%E7%BB%83%E6%8A%80%E5%B7%A7/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E5%B0%81%E9%9D%A2.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">ä¸Šä¸€ç¯‡</div><div class="prev_info">æå®æ¯…æ·±åº¦å­¦ä¹ 2021æ˜¥p5-9ï¼šç¥ç»ç½‘ç»œè®­ç»ƒæŠ€å·§</div></div></a></div><div class="next-post pull-right"><a href="/2021/08/31/BERT%E5%AE%9E%E6%88%98%E2%80%94%E2%80%94%EF%BC%886%EF%BC%89%E7%94%9F%E6%88%90%E4%BB%BB%E5%8A%A1-%E6%91%98%E8%A6%81%E7%94%9F%E6%88%90/"><img class="next-cover" src="/2021/08/26/BERT%E5%AE%9E%E6%88%98%E2%80%94%E2%80%94%EF%BC%881%EF%BC%89%E6%96%87%E6%9C%AC%E5%88%86%E7%B1%BB/huggingFace.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">ä¸‹ä¸€ç¯‡</div><div class="next_info">BERTå®æˆ˜â€”â€”ï¼ˆ6ï¼‰ç”Ÿæˆä»»åŠ¡-æ‘˜è¦ç”Ÿæˆ</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> ç›¸å…³æ¨è</span></div><div class="relatedPosts-list"><div><a href="/2021/08/20/BERTç›¸å…³â€”â€”ï¼ˆ2ï¼‰Contextualized_Word_Embeddingå’ŒELMOæ¨¡å‹/" title="BERTç›¸å…³â€”â€”ï¼ˆ2ï¼‰Contextualized Word Embeddingå’ŒELMOæ¨¡å‹"><img class="cover" src="/2021/08/20/BERT%E7%9B%B8%E5%85%B3%E2%80%94%E2%80%94%EF%BC%881%EF%BC%89%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B/BERT%E5%AE%B6%E6%97%8F.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-08-20</div><div class="title">BERTç›¸å…³â€”â€”ï¼ˆ2ï¼‰Contextualized Word Embeddingå’ŒELMOæ¨¡å‹</div></div></a></div><div><a href="/2021/08/20/BERTç›¸å…³â€”â€”ï¼ˆ3ï¼‰BERTæ¨¡å‹/" title="BERTç›¸å…³â€”â€”ï¼ˆ3ï¼‰BERTæ¨¡å‹"><img class="cover" src="/2021/08/20/BERT%E7%9B%B8%E5%85%B3%E2%80%94%E2%80%94%EF%BC%881%EF%BC%89%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B/BERT%E5%AE%B6%E6%97%8F.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-08-20</div><div class="title">BERTç›¸å…³â€”â€”ï¼ˆ3ï¼‰BERTæ¨¡å‹</div></div></a></div><div><a href="/2021/08/20/BERTç›¸å…³â€”â€”ï¼ˆ1ï¼‰è¯­è¨€æ¨¡å‹/" title="BERTç›¸å…³â€”â€”ï¼ˆ1ï¼‰è¯­è¨€æ¨¡å‹"><img class="cover" src="/2021/08/20/BERT%E7%9B%B8%E5%85%B3%E2%80%94%E2%80%94%EF%BC%881%EF%BC%89%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B/BERT%E5%AE%B6%E6%97%8F.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-08-20</div><div class="title">BERTç›¸å…³â€”â€”ï¼ˆ1ï¼‰è¯­è¨€æ¨¡å‹</div></div></a></div><div><a href="/2021/08/20/BERTç›¸å…³â€”â€”ï¼ˆ4ï¼‰GPTæ¨¡å‹/" title="BERTç›¸å…³â€”â€”ï¼ˆ4ï¼‰GPT-2æ¨¡å‹"><img class="cover" src="/2021/08/20/BERT%E7%9B%B8%E5%85%B3%E2%80%94%E2%80%94%EF%BC%881%EF%BC%89%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B/BERT%E5%AE%B6%E6%97%8F.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-08-20</div><div class="title">BERTç›¸å…³â€”â€”ï¼ˆ4ï¼‰GPT-2æ¨¡å‹</div></div></a></div><div><a href="/2021/08/22/BERTç›¸å…³â€”â€”ï¼ˆ5ï¼‰Pre-train Model/" title="BERTç›¸å…³â€”â€”ï¼ˆ5ï¼‰Pre-train Model"><img class="cover" src="/2021/08/20/BERT%E7%9B%B8%E5%85%B3%E2%80%94%E2%80%94%EF%BC%881%EF%BC%89%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B/BERT%E5%AE%B6%E6%97%8F.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-08-22</div><div class="title">BERTç›¸å…³â€”â€”ï¼ˆ5ï¼‰Pre-train Model</div></div></a></div><div><a href="/2021/08/24/BERTç›¸å…³â€”â€”ï¼ˆ7ï¼‰æŠŠBERTåº”ç”¨åˆ°ä¸‹æ¸¸ä»»åŠ¡/" title="BERTç›¸å…³â€”â€”ï¼ˆ7ï¼‰å°†BERTåº”ç”¨åˆ°ä¸‹æ¸¸ä»»åŠ¡"><img class="cover" src="/2021/08/20/BERT%E7%9B%B8%E5%85%B3%E2%80%94%E2%80%94%EF%BC%881%EF%BC%89%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B/BERT%E5%AE%B6%E6%97%8F.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-08-24</div><div class="title">BERTç›¸å…³â€”â€”ï¼ˆ7ï¼‰å°†BERTåº”ç”¨åˆ°ä¸‹æ¸¸ä»»åŠ¡</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> è¯„è®º</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>ç›®å½•</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#bert%E5%AE%9E%E6%88%987%E7%94%9F%E6%88%90%E4%BB%BB%E5%8A%A1-%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B"><span class="toc-number">1.</span> <span class="toc-text">BERTå®æˆ˜â€”â€”ï¼ˆ7ï¼‰ç”Ÿæˆä»»åŠ¡-è¯­è¨€æ¨¡å‹</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%95%E8%A8%80"><span class="toc-number">1.1.</span> <span class="toc-text">å¼•è¨€</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%BB%E5%8A%A1%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.1.1.</span> <span class="toc-text">ä»»åŠ¡ä»‹ç»</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%8D%E6%9C%9F%E5%87%86%E5%A4%87"><span class="toc-number">1.1.2.</span> <span class="toc-text">å‰æœŸå‡†å¤‡</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%8A%A0%E8%BD%BD"><span class="toc-number">1.2.</span> <span class="toc-text">æ•°æ®åŠ è½½</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E9%9B%86%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.2.1.</span> <span class="toc-text">æ•°æ®é›†ä»‹ç»</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%A0%E8%BD%BD%E6%95%B0%E6%8D%AE"><span class="toc-number">1.2.2.</span> <span class="toc-text">åŠ è½½æ•°æ®</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%A0%E6%9E%9C%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8Bcausal-language-modelingclm"><span class="toc-number">1.3.</span> <span class="toc-text">å› æœè¯­è¨€æ¨¡å‹ï¼ˆCausal Language Modelingï¼ŒCLMï¼‰</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E9%A2%84%E5%A4%84%E7%90%86"><span class="toc-number">1.3.1.</span> <span class="toc-text">æ•°æ®é¢„å¤„ç†</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96tokenizer"><span class="toc-number">1.3.1.1.</span> <span class="toc-text">åˆå§‹åŒ–Tokenizer</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BD%AC%E5%8C%96%E6%88%90%E5%AF%B9%E5%BA%94%E4%BB%BB%E5%8A%A1%E8%BE%93%E5%85%A5%E6%A8%A1%E5%9E%8B%E7%9A%84%E6%A0%BC%E5%BC%8F"><span class="toc-number">1.3.1.2.</span> <span class="toc-text">è½¬åŒ–æˆå¯¹åº”ä»»åŠ¡è¾“å…¥æ¨¡å‹çš„æ ¼å¼</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%B0%83%E7%94%A8%E5%88%86%E8%AF%8D%E5%99%A8%E5%AF%B9%E6%89%80%E6%9C%89%E7%9A%84%E6%96%87%E6%9C%AC%E5%88%86%E8%AF%8D"><span class="toc-number">1.3.1.2.1.</span> <span class="toc-text">è°ƒç”¨åˆ†è¯å™¨å¯¹æ‰€æœ‰çš„æ–‡æœ¬åˆ†è¯</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8B%BC%E6%8E%A5%E6%96%87%E6%9C%AC%E6%8C%89%E5%AE%9A%E9%95%BF%E6%8B%86%E5%88%86%E6%96%87%E6%9C%AC"><span class="toc-number">1.3.1.2.2.</span> <span class="toc-text">æ‹¼æ¥æ–‡æœ¬&amp;æŒ‰å®šé•¿æ‹†åˆ†æ–‡æœ¬</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BE%AE%E8%B0%83%E9%A2%84%E8%AE%AD%E7%BB%83%E6%A8%A1%E5%9E%8B"><span class="toc-number">1.3.2.</span> <span class="toc-text">å¾®è°ƒé¢„è®­ç»ƒæ¨¡å‹</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8A%A0%E8%BD%BD%E9%A2%84%E8%AE%AD%E7%BB%83%E6%A8%A1%E5%9E%8B"><span class="toc-number">1.3.2.1.</span> <span class="toc-text">åŠ è½½é¢„è®­ç»ƒæ¨¡å‹</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AE%BE%E5%AE%9A%E8%AE%AD%E7%BB%83%E5%8F%82%E6%95%B0"><span class="toc-number">1.3.2.2.</span> <span class="toc-text">è®¾å®šè®­ç»ƒå‚æ•°</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89%E8%AF%84%E4%BC%B0%E6%96%B9%E6%B3%95"><span class="toc-number">1.3.2.3.</span> <span class="toc-text">å®šä¹‰è¯„ä¼°æ–¹æ³•</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%80%E5%A7%8B%E8%AE%AD%E7%BB%83"><span class="toc-number">1.3.2.4.</span> <span class="toc-text">å¼€å§‹è®­ç»ƒ</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%84%E4%BC%B0%E6%A8%A1%E5%9E%8B"><span class="toc-number">1.3.3.</span> <span class="toc-text">è¯„ä¼°æ¨¡å‹</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8E%A9%E7%A0%81%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8Bmask-language-modelingmlm"><span class="toc-number">1.4.</span> <span class="toc-text">æ©ç è¯­è¨€æ¨¡å‹ï¼ˆMask Language Modelingï¼ŒMLMï¼‰</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E9%A2%84%E5%A4%84%E7%90%86-1"><span class="toc-number">1.4.1.</span> <span class="toc-text">æ•°æ®é¢„å¤„ç†</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96tokenizer-1"><span class="toc-number">1.4.1.1.</span> <span class="toc-text">åˆå§‹åŒ–Tokenizer</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BD%AC%E5%8C%96%E6%88%90%E5%AF%B9%E5%BA%94%E4%BB%BB%E5%8A%A1%E8%BE%93%E5%85%A5%E6%A8%A1%E5%9E%8B%E7%9A%84%E6%A0%BC%E5%BC%8F-1"><span class="toc-number">1.4.1.2.</span> <span class="toc-text">è½¬åŒ–æˆå¯¹åº”ä»»åŠ¡è¾“å…¥æ¨¡å‹çš„æ ¼å¼</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%B0%83%E7%94%A8%E5%88%86%E8%AF%8D%E5%99%A8%E5%AF%B9%E6%89%80%E6%9C%89%E7%9A%84%E6%96%87%E6%9C%AC%E5%88%86%E8%AF%8D-1"><span class="toc-number">1.4.1.2.1.</span> <span class="toc-text">è°ƒç”¨åˆ†è¯å™¨å¯¹æ‰€æœ‰çš„æ–‡æœ¬åˆ†è¯</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8B%BC%E6%8E%A5%E6%96%87%E6%9C%AC%E6%8C%89%E5%AE%9A%E9%95%BF%E6%8B%86%E5%88%86%E6%96%87%E6%9C%AC-1"><span class="toc-number">1.4.1.2.2.</span> <span class="toc-text">æ‹¼æ¥æ–‡æœ¬&amp;æŒ‰å®šé•¿æ‹†åˆ†æ–‡æœ¬</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BE%AE%E8%B0%83%E9%A2%84%E8%AE%AD%E7%BB%83%E6%A8%A1%E5%9E%8B-1"><span class="toc-number">1.4.2.</span> <span class="toc-text">å¾®è°ƒé¢„è®­ç»ƒæ¨¡å‹</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8A%A0%E8%BD%BD%E9%A2%84%E8%AE%AD%E7%BB%83%E6%A8%A1%E5%9E%8B-1"><span class="toc-number">1.4.2.1.</span> <span class="toc-text">åŠ è½½é¢„è®­ç»ƒæ¨¡å‹</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AE%BE%E5%AE%9A%E8%AE%AD%E7%BB%83%E5%8F%82%E6%95%B0-1"><span class="toc-number">1.4.2.2.</span> <span class="toc-text">è®¾å®šè®­ç»ƒå‚æ•°</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E6%94%B6%E9%9B%86%E5%99%A8data-collator"><span class="toc-number">1.4.3.</span> <span class="toc-text">æ•°æ®æ”¶é›†å™¨data collator</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89%E8%AF%84%E4%BC%B0%E6%96%B9%E6%B3%95-1"><span class="toc-number">1.4.3.1.</span> <span class="toc-text">å®šä¹‰è¯„ä¼°æ–¹æ³•</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%80%E5%A7%8B%E8%AE%AD%E7%BB%83-1"><span class="toc-number">1.4.3.2.</span> <span class="toc-text">å¼€å§‹è®­ç»ƒ</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%84%E4%BC%B0%E6%A8%A1%E5%9E%8B-1"><span class="toc-number">1.4.4.</span> <span class="toc-text">è¯„ä¼°æ¨¡å‹</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE"><span class="toc-number">1.5.</span> <span class="toc-text">å‚è€ƒæ–‡çŒ®</span></a></li></ol></li></ol></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2021 By å†¬äº</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="é˜…è¯»æ¨¡å¼"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="æµ…è‰²å’Œæ·±è‰²æ¨¡å¼è½¬æ¢"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="å•æ å’ŒåŒæ åˆ‡æ¢"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="è®¾ç½®"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="ç›®å½•"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="ç›´è¾¾è¯„è®º"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="å›åˆ°é¡¶éƒ¨"><i class="fas fa-arrow-up"></i></button></div></div><div id="algolia-search"><div class="search-dialog"><div class="search-dialog__title" id="algolia-search-title">Algolia</div><div id="algolia-input-panel"><div id="algolia-search-input"></div></div><hr/><div id="algolia-search-results"><div id="algolia-hits"></div><div id="algolia-pagination"></div><div id="algolia-stats"></div></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script src="/js/search/algolia.js"></script><script>var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())</script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    loader: {
      source: {
        '[tex]/amsCd': '[tex]/amscd'
      }
    },
    tex: {
      inlineMath: [ ['$','$'], ["\\(","\\)"]],
      tags: 'ams'
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, ''],
        addClass: [200,() => {
          document.querySelectorAll('mjx-container:not([display=\'true\']').forEach( node => {
            const target = node.parentNode
            if (!target.classList.contains('has-jax')) {
              target.classList.add('mathjax-overflow')
            }
          })
        }, '', false]
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typeset()
}</script><script>function loadValine () {
  function initValine () {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: 'E4LPmFetYyaT4NwjEGOl0u8Q-gzGzoHsz',
      appKey: 'YKdl4HKX9W6jLSdPlypgEtDM',
      placeholder: 'Please leave your footprints',
      avatar: 'monsterid',
      meta: 'nick,mail,link'.split(','),
      pageSize: '10',
      lang: 'zh-CN',
      recordIP: false,
      serverURLs: 'https://e4lpmfet.lc-cn-n1-shared.com',
      emojiCDN: '',
      emojiMaps: "",
      enableQQ: false,
      path: window.location.pathname,
      requiredFields: ["nick,mail"],
      visitor: false
    }, null))
  }

  if (typeof Valine === 'function') initValine() 
  else getScript('https://cdn.jsdelivr.net/gh/HCLonely/Valine@latest/dist/Valine.min.js').then(initValine)
}

if ('Valine' === 'Valine' || !true) {
  if (true) btf.loadComment(document.getElementById('vcomment'),loadValine)
  else setTimeout(loadValine, 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script></div><script src="https://cdn.jsdelivr.net/npm/blueimp-md5@2.17.0/js/md5.min.js"></script><script>window.addEventListener('load', () => {
  const changeContent = (content) => {
    if (content === '') return content

    content = content.replace(/<img.*?src="(.*?)"?[^\>]+>/ig, '[å›¾ç‰‡]') // replace image link
    content = content.replace(/<a[^>]+?href=["']?([^"']+)["']?[^>]*>([^<]+)<\/a>/gi, '[é“¾æ¥]') // replace url
    content = content.replace(/<pre><code>.*?<\/pre>/gi, '[ä»£ç ]') // replace code
    content = content.replace(/<[^>]+>/g,"") // remove html tag

    if (content.length > 150) {
      content = content.substring(0,150) + '...'
    }
    return content
  }

  const getIcon = (icon, mail) => {
    if (icon) return icon
    let defaultIcon = '?d=monsterid'
    let iconUrl = `https://gravatar.loli.net/avatar/${md5(mail.toLowerCase()) + defaultIcon}`
    return iconUrl
  }

  const generateHtml = array => {
    let result = ''

    if (array.length) {
      for (let i = 0; i < array.length; i++) {
        result += '<div class=\'aside-list-item\'>'

        if (true) {
          const name = 'src'
          result += `<a href='${array[i].url}' class='thumbnail'><img ${name}='${array[i].avatar}' alt='${array[i].nick}'></a>`
        }

        result += `<div class='content'>
        <a class='comment' href='${array[i].url}'>${array[i].content}</a>
        <div class='name'><span>${array[i].nick} / </span><time datetime="${array[i].date}">${btf.diffDate(array[i].date, true)}</time></div>
        </div></div>`
      }
    } else {
      result += 'æ²¡æœ‰è¯„è®º'
    }

    let $dom = document.querySelector('#card-newest-comments .aside-list')
    $dom.innerHTML= result
    window.lazyLoadInstance && window.lazyLoadInstance.update()
    window.pjax && window.pjax.refresh($dom)
  }

  const getComment = () => {
    const serverURL = 'https://e4lpmfet.lc-cn-n1-shared.com'

    var settings = {
      "method": "GET",
      "headers": {
        "X-LC-Id": 'E4LPmFetYyaT4NwjEGOl0u8Q-gzGzoHsz',
        "X-LC-Key": 'YKdl4HKX9W6jLSdPlypgEtDM',
        "Content-Type": "application/json"
      },
    }

    fetch(`${serverURL}/1.1/classes/Comment?limit=6&order=-createdAt`,settings)
      .then(response => response.json())
      .then(data => {
        const valineArray = data.results.map(function (e) {
          return {
            'avatar': getIcon(e.QQAvatar, e.mail),
            'content': changeContent(e.comment),
            'nick': e.nick,
            'url': e.url + '#' + e.objectId,
            'date': e.updatedAt,
          }
        })
        saveToLocal.set('valine-newest-comments', JSON.stringify(valineArray), 10/(60*24))
        generateHtml(valineArray)
      }).catch(e => {
        const $dom = document.querySelector('#card-newest-comments .aside-list')
        $dom.innerHTML= "æ— æ³•è·å–è¯„è®ºï¼Œè¯·ç¡®è®¤ç›¸å…³é…ç½®æ˜¯å¦æ­£ç¡®"
      }) 
  }

  const newestCommentInit = () => {
    if (document.querySelector('#card-newest-comments .aside-list')) {
      const data = saveToLocal.get('valine-newest-comments')
      if (data) {
        generateHtml(JSON.parse(data))
      } else {
        getComment()
      }
    }
  }

  newestCommentInit()
  document.addEventListener('pjax:complete', newestCommentInit)
})</script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors = [
  'title',
  '#config-diff',
  '#body-wrap',
  '#rightside-config-hide',
  '#rightside-config-show',
  '.js-pjax'
]

if (false) {
  pjaxSelectors.unshift('meta[property="og:image"]', 'meta[property="og:title"]', 'meta[property="og:url"]')
}

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener toc scroll 
  window.removeEventListener('scroll', window.tocScrollFn)

  typeof preloader === 'object' && preloader.initLoading()
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // Analytics
  if (false) {
    MtaH5.pgv()
  }

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()

  typeof preloader === 'object' && preloader.endLoading()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>