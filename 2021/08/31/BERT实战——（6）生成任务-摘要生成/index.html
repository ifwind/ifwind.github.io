<!DOCTYPE html><html class="hide-aside" lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>BERTå®æˆ˜â€”â€”ï¼ˆ6ï¼‰ç”Ÿæˆä»»åŠ¡-æ‘˜è¦ç”Ÿæˆ | å†¬äºçš„åšå®¢</title><meta name="keywords" content="æ·±åº¦å­¦ä¹ ,NLP,BERT"><meta name="author" content="å†¬äº"><meta name="copyright" content="å†¬äº"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="BERTå®æˆ˜â€”â€”ï¼ˆ6ï¼‰ç”Ÿæˆä»»åŠ¡-æ‘˜è¦ç”Ÿæˆ  å¼•è¨€ è¿™ä¸€ç¯‡å°†ä»‹ç»å¦‚ä½•ä½¿ç”¨ ğŸ¤— Transformersä»£ç åº“ä¸­çš„æ¨¡å‹æ¥è§£å†³ç”Ÿæˆä»»åŠ¡ä¸­çš„æ‘˜è¦ç”Ÿæˆé—®é¢˜ã€‚  ä»»åŠ¡ä»‹ç» æ‘˜è¦ç”Ÿæˆï¼Œç”¨ä¸€äº›ç²¾ç‚¼çš„è¯ï¼ˆæ‘˜è¦ï¼‰æ¥æ¦‚æ‹¬æ•´ç‰‡æ–‡ç« çš„å¤§æ„ï¼Œç”¨æˆ·é€šè¿‡è¯»æ–‡æ‘˜å°±å¯ä»¥äº†è§£åˆ°åŸæ–‡è¦è¡¨è¾¾ã€‚ ä¸»è¦åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†ï¼š  æ•°æ®åŠ è½½ï¼› æ•°æ®é¢„å¤„ç†ï¼› å¾®è°ƒé¢„è®­ç»ƒæ¨¡å‹ï¼šä½¿ç”¨transformerä¸­çš„**Seq2SeqTraineræ¥å£**å¯¹é¢„">
<meta property="og:type" content="article">
<meta property="og:title" content="BERTå®æˆ˜â€”â€”ï¼ˆ6ï¼‰ç”Ÿæˆä»»åŠ¡-æ‘˜è¦ç”Ÿæˆ">
<meta property="og:url" content="https://ifwind.github.io/2021/08/31/BERT%E5%AE%9E%E6%88%98%E2%80%94%E2%80%94%EF%BC%886%EF%BC%89%E7%94%9F%E6%88%90%E4%BB%BB%E5%8A%A1-%E6%91%98%E8%A6%81%E7%94%9F%E6%88%90/index.html">
<meta property="og:site_name" content="å†¬äºçš„åšå®¢">
<meta property="og:description" content="BERTå®æˆ˜â€”â€”ï¼ˆ6ï¼‰ç”Ÿæˆä»»åŠ¡-æ‘˜è¦ç”Ÿæˆ  å¼•è¨€ è¿™ä¸€ç¯‡å°†ä»‹ç»å¦‚ä½•ä½¿ç”¨ ğŸ¤— Transformersä»£ç åº“ä¸­çš„æ¨¡å‹æ¥è§£å†³ç”Ÿæˆä»»åŠ¡ä¸­çš„æ‘˜è¦ç”Ÿæˆé—®é¢˜ã€‚  ä»»åŠ¡ä»‹ç» æ‘˜è¦ç”Ÿæˆï¼Œç”¨ä¸€äº›ç²¾ç‚¼çš„è¯ï¼ˆæ‘˜è¦ï¼‰æ¥æ¦‚æ‹¬æ•´ç‰‡æ–‡ç« çš„å¤§æ„ï¼Œç”¨æˆ·é€šè¿‡è¯»æ–‡æ‘˜å°±å¯ä»¥äº†è§£åˆ°åŸæ–‡è¦è¡¨è¾¾ã€‚ ä¸»è¦åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†ï¼š  æ•°æ®åŠ è½½ï¼› æ•°æ®é¢„å¤„ç†ï¼› å¾®è°ƒé¢„è®­ç»ƒæ¨¡å‹ï¼šä½¿ç”¨transformerä¸­çš„**Seq2SeqTraineræ¥å£**å¯¹é¢„">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://ifwind.github.io/2021/08/26/BERT%E5%AE%9E%E6%88%98%E2%80%94%E2%80%94%EF%BC%881%EF%BC%89%E6%96%87%E6%9C%AC%E5%88%86%E7%B1%BB/huggingFace.jpg">
<meta property="article:published_time" content="2021-08-31T05:59:10.000Z">
<meta property="article:modified_time" content="2021-09-01T12:01:18.351Z">
<meta property="article:author" content="å†¬äº">
<meta property="article:tag" content="æ·±åº¦å­¦ä¹ ">
<meta property="article:tag" content="NLP">
<meta property="article:tag" content="BERT">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://ifwind.github.io/2021/08/26/BERT%E5%AE%9E%E6%88%98%E2%80%94%E2%80%94%EF%BC%881%EF%BC%89%E6%96%87%E6%9C%AC%E5%88%86%E7%B1%BB/huggingFace.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://ifwind.github.io/2021/08/31/BERT%E5%AE%9E%E6%88%98%E2%80%94%E2%80%94%EF%BC%886%EF%BC%89%E7%94%9F%E6%88%90%E4%BB%BB%E5%8A%A1-%E6%91%98%E8%A6%81%E7%94%9F%E6%88%90/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.10.5/dist/instantsearch.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.10.5/dist/instantsearch.min.js" defer></script><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: {"appId":"LVK1P2D38K","apiKey":"8cbbb0bcbb5c7448f68b4fae01d4ccd5","indexName":"DongYu","hits":{"per_page":6},"languages":{"input_placeholder":"æœç´¢æ–‡ç« ","hits_empty":"æ‰¾ä¸åˆ°æ‚¨æŸ¥è¯¢çš„å†…å®¹ï¼š${query}","hits_stats":"æ‰¾åˆ° ${hits} æ¡ç»“æœï¼Œç”¨æ—¶ ${time} æ¯«ç§’"}},
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'å¤åˆ¶æˆåŠŸ',
    error: 'å¤åˆ¶é”™è¯¯',
    noSupport: 'æµè§ˆå™¨ä¸æ”¯æŒ'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: 'å¤©',
  date_suffix: {
    just: 'åˆšåˆš',
    min: 'åˆ†é’Ÿå‰',
    hour: 'å°æ—¶å‰',
    day: 'å¤©å‰',
    month: 'ä¸ªæœˆå‰'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"ä½ å·²åˆ‡æ¢ä¸ºç¹ä½“","cht_to_chs":"ä½ å·²åˆ‡æ¢ä¸ºç®€ä½“","day_to_night":"ä½ å·²åˆ‡æ¢ä¸ºæ·±è‰²æ¨¡å¼","night_to_day":"ä½ å·²åˆ‡æ¢ä¸ºæµ…è‰²æ¨¡å¼","bgLight":"#49b1f5","bgDark":"#121212","position":"bottom-left"},
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: true,
  islazyload: false,
  isanchor: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'BERTå®æˆ˜â€”â€”ï¼ˆ6ï¼‰ç”Ÿæˆä»»åŠ¡-æ‘˜è¦ç”Ÿæˆ',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2021-09-01 20:01:18'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    })(window)</script><link rel="stylesheet" href="/css/custom.css"><meta name="generator" content="Hexo 5.4.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">åŠ è½½ä¸­...</div></div></div><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src="/img/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">æ–‡ç« </div><div class="length-num">89</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">æ ‡ç­¾</div><div class="length-num">54</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">åˆ†ç±»</div><div class="length-num">7</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> é¦–é¡µ</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-compass"></i><span> åˆ†ç±»</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> æ—¶é—´è½´</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> æ ‡ç­¾</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> ç±»åˆ«</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-star"></i><span> Spark</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> éŸ³ä¹</span></a></li><li><a class="site-page child" href="/gallery/"><i class="fa-fw fas fa-images"></i><span> ç…§ç‰‡</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fas fa-comment-dots"></i><span> ç•™è¨€æ¿</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> å‹é“¾</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-duotone fa-user"></i><span> å…³äº</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/2021/08/26/BERT%E5%AE%9E%E6%88%98%E2%80%94%E2%80%94%EF%BC%881%EF%BC%89%E6%96%87%E6%9C%AC%E5%88%86%E7%B1%BB/huggingFace.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">å†¬äºçš„åšå®¢</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> æœç´¢</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> é¦–é¡µ</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-compass"></i><span> åˆ†ç±»</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> æ—¶é—´è½´</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> æ ‡ç­¾</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> ç±»åˆ«</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-star"></i><span> Spark</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> éŸ³ä¹</span></a></li><li><a class="site-page child" href="/gallery/"><i class="fa-fw fas fa-images"></i><span> ç…§ç‰‡</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fas fa-comment-dots"></i><span> ç•™è¨€æ¿</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> å‹é“¾</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-duotone fa-user"></i><span> å…³äº</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">BERTå®æˆ˜â€”â€”ï¼ˆ6ï¼‰ç”Ÿæˆä»»åŠ¡-æ‘˜è¦ç”Ÿæˆ</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">å‘è¡¨äº</span><time class="post-meta-date-created" datetime="2021-08-31T05:59:10.000Z" title="å‘è¡¨äº 2021-08-31 13:59:10">2021-08-31</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">æ›´æ–°äº</span><time class="post-meta-date-updated" datetime="2021-09-01T12:01:18.351Z" title="æ›´æ–°äº 2021-09-01 20:01:18">2021-09-01</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/">æ·±åº¦å­¦ä¹ </a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">å­—æ•°æ€»è®¡:</span><span class="word-count">2,623</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">é˜…è¯»æ—¶é•¿:</span><span>13åˆ†é’Ÿ</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="BERTå®æˆ˜â€”â€”ï¼ˆ6ï¼‰ç”Ÿæˆä»»åŠ¡-æ‘˜è¦ç”Ÿæˆ"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">é˜…è¯»é‡:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="bertå®æˆ˜6ç”Ÿæˆä»»åŠ¡-æ‘˜è¦ç”Ÿæˆ"><a class="markdownIt-Anchor" href="#bertå®æˆ˜6ç”Ÿæˆä»»åŠ¡-æ‘˜è¦ç”Ÿæˆ"></a> BERTå®æˆ˜â€”â€”ï¼ˆ6ï¼‰ç”Ÿæˆä»»åŠ¡-æ‘˜è¦ç”Ÿæˆ</h1>
<h2 id="å¼•è¨€"><a class="markdownIt-Anchor" href="#å¼•è¨€"></a> å¼•è¨€</h2>
<p>è¿™ä¸€ç¯‡å°†ä»‹ç»å¦‚ä½•ä½¿ç”¨ <a target="_blank" rel="noopener" href="https://github.com/huggingface/transformers">ğŸ¤— Transformers</a>ä»£ç åº“ä¸­çš„æ¨¡å‹æ¥è§£å†³<strong>ç”Ÿæˆä»»åŠ¡ä¸­çš„æ‘˜è¦ç”Ÿæˆé—®é¢˜ã€‚</strong></p>
<h3 id="ä»»åŠ¡ä»‹ç»"><a class="markdownIt-Anchor" href="#ä»»åŠ¡ä»‹ç»"></a> ä»»åŠ¡ä»‹ç»</h3>
<p>æ‘˜è¦ç”Ÿæˆï¼Œç”¨ä¸€äº›ç²¾ç‚¼çš„è¯ï¼ˆæ‘˜è¦ï¼‰æ¥æ¦‚æ‹¬æ•´ç‰‡æ–‡ç« çš„å¤§æ„ï¼Œç”¨æˆ·é€šè¿‡è¯»æ–‡æ‘˜å°±å¯ä»¥äº†è§£åˆ°åŸæ–‡è¦è¡¨è¾¾ã€‚</p>
<p>ä¸»è¦åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†ï¼š</p>
<ol>
<li>æ•°æ®åŠ è½½ï¼›</li>
<li>æ•°æ®é¢„å¤„ç†ï¼›</li>
<li>å¾®è°ƒé¢„è®­ç»ƒæ¨¡å‹ï¼šä½¿ç”¨transformerä¸­çš„**<code>Seq2SeqTrainer</code>æ¥å£**å¯¹é¢„è®­ç»ƒæ¨¡å‹è¿›è¡Œå¾®è°ƒï¼ˆæ³¨æ„è¿™é‡Œæ˜¯<code>Seq2SeqTrainer</code>æ¥å£ï¼Œä¹‹å‰çš„ä»»åŠ¡éƒ½æ˜¯è°ƒç”¨<code>Trainer</code>æ¥å£ï¼‰ã€‚</li>
</ol>
<h3 id="å‰æœŸå‡†å¤‡"><a class="markdownIt-Anchor" href="#å‰æœŸå‡†å¤‡"></a> å‰æœŸå‡†å¤‡</h3>
<p>å®‰è£…ä»¥ä¸‹åº“ï¼š</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">pip install datasets transformers rouge-score nltk</span><br><span class="line"><span class="comment">#transformers==4.9.2</span></span><br><span class="line"><span class="comment">#datasets==1.11.0</span></span><br><span class="line"><span class="comment">#rouge-score==0.0.4</span></span><br><span class="line"><span class="comment">#nltk==3.6.2</span></span><br></pre></td></tr></table></figure>
<h2 id="æ•°æ®åŠ è½½"><a class="markdownIt-Anchor" href="#æ•°æ®åŠ è½½"></a> æ•°æ®åŠ è½½</h2>
<h3 id="æ•°æ®é›†ä»‹ç»"><a class="markdownIt-Anchor" href="#æ•°æ®é›†ä»‹ç»"></a> æ•°æ®é›†ä»‹ç»</h3>
<p>æˆ‘ä»¬ä½¿ç”¨<a target="_blank" rel="noopener" href="https://arxiv.org/pdf/1808.08745.pdf">XSum dataset</a>æ•°æ®é›†ï¼Œå…¶ä¸­åŒ…å«äº†å¤šç¯‡BBCçš„æ–‡ç« å’Œä¸€å¥å¯¹åº”çš„æ‘˜è¦ã€‚</p>
<h3 id="åŠ è½½æ•°æ®"><a class="markdownIt-Anchor" href="#åŠ è½½æ•°æ®"></a> åŠ è½½æ•°æ®</h3>
<p>è¯¥æ•°æ®çš„åŠ è½½æ–¹å¼åœ¨transformersåº“ä¸­è¿›è¡Œäº†å°è£…ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä»¥ä¸‹è¯­å¥è¿›è¡Œæ•°æ®åŠ è½½ï¼š</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> datasets <span class="keyword">import</span> load_dataset</span><br><span class="line">raw_datasets = load_dataset(<span class="string">&quot;xsum&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>ç»™å®šä¸€ä¸ªæ•°æ®åˆ‡åˆ†çš„keyï¼ˆtrainã€validationæˆ–è€…testï¼‰å’Œä¸‹æ ‡å³å¯æŸ¥çœ‹æ•°æ®ã€‚</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">raw_datasets[<span class="string">&quot;train&quot;</span>][<span class="number">0</span>]</span><br><span class="line"><span class="comment"># &#123;&#x27;document&#x27;: &#x27;Recent reports have linked some France-based players with returns to Wales.\n&quot;I\&#x27;ve always felt - and this is with my rugby hat on now; this is not region or WRU - I\&#x27;d rather spend that money on keeping players in Wales,&quot; said Davies.\nThe WRU provides Â£2m to the fund and Â£1.3m comes from the regions.\nFormer Wales and British and Irish Lions fly-half Davies became WRU chairman on Tuesday 21 October, succeeding deposed David Pickering following governing body elections.\nHe is now serving a notice period to leave his role as Newport Gwent Dragons chief executive after being voted on to the WRU board in September.\nDavies was among the leading figures among Dragons, Ospreys, Scarlets and Cardiff Blues officials who were embroiled in a protracted dispute with the WRU that ended in a Â£60m deal in August this year.\nIn the wake of that deal being done, Davies said the Â£3.3m should be spent on ensuring current Wales-based stars remain there.\nIn recent weeks, Racing Metro flanker Dan Lydiate was linked with returning to Wales.\nLikewise the Paris club\&#x27;s scrum-half Mike Phillips and centre Jamie Roberts were also touted for possible returns.\nWales coach Warren Gatland has said: &quot;We haven\&#x27;t instigated contact with the players.\n&quot;But we are aware that one or two of them are keen to return to Wales sooner rather than later.&quot;\nSpeaking to Scrum V on BBC Radio Wales, Davies re-iterated his stance, saying keeping players such as Scarlets full-back Liam Williams and Ospreys flanker Justin Tipuric in Wales should take precedence.\n&quot;It\&#x27;s obviously a limited amount of money [available]. The union are contributing 60% of that contract and the regions are putting Â£1.3m in.\n&quot;So it\&#x27;s a total pot of just over Â£3m and if you look at the sorts of salaries that the... guys... have been tempted to go overseas for [are] significant amounts of money.\n&quot;So if we were to bring the players back, we\&#x27;d probably get five or six players.\n&quot;And I\&#x27;ve always felt - and this is with my rugby hat on now; this is not region or WRU - I\&#x27;d rather spend that money on keeping players in Wales.\n&quot;There are players coming out of contract, perhaps in the next year or soâ€¦ you\&#x27;re looking at your Liam Williams\&#x27; of the world; Justin Tipuric for example - we need to keep these guys in Wales.\n&quot;We actually want them there. They are the ones who are going to impress the young kids, for example.\n&quot;They are the sort of heroes that our young kids want to emulate.\n&quot;So I would start off [by saying] with the limited pot of money, we have to retain players in Wales.\n&quot;Now, if that can be done and there\&#x27;s some spare monies available at the end, yes, let\&#x27;s look to bring players back.\n&quot;But it\&#x27;s a cruel world, isn\&#x27;t it?\n&quot;It\&#x27;s fine to take the buck and go, but great if you can get them back as well, provided there\&#x27;s enough money.&quot;\nBritish and Irish Lions centre Roberts has insisted he will see out his Racing Metro contract.\nHe and Phillips also earlier dismissed the idea of leaving Paris.\nRoberts also admitted being hurt by comments in French Newspaper L\&#x27;Equipe attributed to Racing Coach Laurent Labit questioning their effectiveness.\nCentre Roberts and flanker Lydiate joined Racing ahead of the 2013-14 season while scrum-half Phillips moved there in December 2013 after being dismissed for disciplinary reasons by former club Bayonne.&#x27;,</span></span><br><span class="line"><span class="comment"># &#x27;id&#x27;: &#x27;29750031&#x27;,</span></span><br><span class="line"><span class="comment"># &#x27;summary&#x27;: &#x27;New Welsh Rugby Union chairman Gareth Davies believes a joint Â£3.3m WRU-regions fund should be used to retain home-based talent such as Liam Williams, not bring back exiled stars.&#x27;&#125;</span></span><br></pre></td></tr></table></figure>
<p>ä¸‹é¢çš„å‡½æ•°å°†ä»æ•°æ®é›†é‡Œéšæœºé€‰æ‹©å‡ ä¸ªä¾‹å­è¿›è¡Œå±•ç¤ºï¼š</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> datasets</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">from</span> IPython.display <span class="keyword">import</span> display, HTML</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show_random_elements</span>(<span class="params">dataset, num_examples=<span class="number">1</span></span>):</span></span><br><span class="line">    <span class="keyword">assert</span> num_examples &lt;= <span class="built_in">len</span>(dataset), <span class="string">&quot;Can&#x27;t pick more elements than there are in the dataset.&quot;</span></span><br><span class="line">    picks = []</span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(num_examples):</span><br><span class="line">        pick = random.randint(<span class="number">0</span>, <span class="built_in">len</span>(dataset)-<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">while</span> pick <span class="keyword">in</span> picks:</span><br><span class="line">            pick = random.randint(<span class="number">0</span>, <span class="built_in">len</span>(dataset)-<span class="number">1</span>)</span><br><span class="line">        picks.append(pick)</span><br><span class="line">    </span><br><span class="line">    df = pd.DataFrame(dataset[picks])</span><br><span class="line">    <span class="keyword">for</span> column, typ <span class="keyword">in</span> dataset.features.items():</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(typ, datasets.ClassLabel):</span><br><span class="line">            df[column] = df[column].transform(<span class="keyword">lambda</span> i: typ.names[i])</span><br><span class="line">    display(HTML(df.to_html()))</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">show_random_elements(raw_datasets[<span class="string">&quot;train&quot;</span>][<span class="number">1</span>:])</span><br></pre></td></tr></table></figure>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>document</th>
      <th>id</th>
      <th>summary</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Media playback is unsupported on your device\n18 December 2014 Last updated at 10:28 GMT\nMalaysia has successfully tackled poverty over the last four decades by drawing on its rich natural resources.\nAccording to the World Bank, some 49% of Malaysians in 1970 were extremely poor, and that figure has been reduced to 1% today. However, the government's next challenge is to help the lower income group to move up to the middle class, the bank says.\nUlrich Zahau, the World Bank's Southeast Asia director, spoke to the BBC's Jennifer Pak.</td>
      <td>30530533</td>
      <td>In Malaysia the "aspirational" low-income part of the population is helping to drive economic growth through consumption, according to the World Bank.</td>
    </tr>
  </tbody>
</table>
<h2 id="æ•°æ®é¢„å¤„ç†"><a class="markdownIt-Anchor" href="#æ•°æ®é¢„å¤„ç†"></a> æ•°æ®é¢„å¤„ç†</h2>
<p>åœ¨å°†æ•°æ®å–‚å…¥æ¨¡å‹ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å¯¹æ•°æ®è¿›è¡Œé¢„å¤„ç†ã€‚</p>
<p>ä»ç„¶æ˜¯ä¸¤ä¸ªæ•°æ®é¢„å¤„ç†çš„åŸºæœ¬æµç¨‹ï¼š</p>
<ol>
<li>åˆ†è¯ï¼›</li>
<li>è½¬åŒ–æˆå¯¹åº”ä»»åŠ¡è¾“å…¥æ¨¡å‹çš„æ ¼å¼ï¼›</li>
</ol>
<p><code>Tokenizer</code>ç”¨äºä¸Šé¢ä¸¤æ­¥æ•°æ®é¢„å¤„ç†å·¥ä½œï¼š<code>Tokenizer</code>é¦–å…ˆå¯¹è¾“å…¥è¿›è¡Œtokenizeï¼Œç„¶åå°†tokensè½¬åŒ–ä¸ºé¢„æ¨¡å‹ä¸­éœ€è¦å¯¹åº”çš„token IDï¼Œå†è½¬åŒ–ä¸ºæ¨¡å‹éœ€è¦çš„è¾“å…¥æ ¼å¼ã€‚</p>
<h3 id="åˆå§‹åŒ–tokenizer"><a class="markdownIt-Anchor" href="#åˆå§‹åŒ–tokenizer"></a> åˆå§‹åŒ–Tokenizer</h3>
<p><a href="https://ifwind.github.io/2021/08/26/BERT%E5%AE%9E%E6%88%98%E2%80%94%E2%80%94%EF%BC%881%EF%BC%89%E6%96%87%E6%9C%AC%E5%88%86%E7%B1%BB/#%E5%88%9D%E5%A7%8B%E5%8C%96Tokenizer">ä¹‹å‰çš„åšå®¢</a>å·²ç»ä»‹ç»äº†ä¸€äº›Tokenizerçš„å†…å®¹ï¼Œå¹¶åšäº†Tokenizeråˆ†è¯çš„ç¤ºä¾‹ï¼Œè¿™é‡Œä¸å†é‡å¤ã€‚<code>use_fast=True</code>æŒ‡å®šä½¿ç”¨fastç‰ˆæœ¬çš„tokenizerã€‚</p>
<p>æˆ‘ä»¬ä½¿ç”¨<a target="_blank" rel="noopener" href="https://huggingface.co/t5-small"><code>t5-small</code></a>æ¨¡å‹checkpointæ¥åšè¯¥ä»»åŠ¡ã€‚</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> transformers <span class="keyword">import</span> AutoTokenizer</span><br><span class="line">model_checkpoint = <span class="string">&quot;t5-small&quot;</span></span><br><span class="line">tokenizer = AutoTokenizer.from_pretrained(model_checkpoint, use_fast=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>
<h3 id="è½¬åŒ–æˆå¯¹åº”ä»»åŠ¡è¾“å…¥æ¨¡å‹çš„æ ¼å¼"><a class="markdownIt-Anchor" href="#è½¬åŒ–æˆå¯¹åº”ä»»åŠ¡è¾“å…¥æ¨¡å‹çš„æ ¼å¼"></a> è½¬åŒ–æˆå¯¹åº”ä»»åŠ¡è¾“å…¥æ¨¡å‹çš„æ ¼å¼</h3>
<p>æ¨¡å‹çš„è¾“å…¥ä¸ºå¾…ç¿»è¯‘çš„å¥å­ã€‚</p>
<p><strong>æ³¨æ„ï¼šä¸ºäº†ç»™æ¨¡å‹å‡†å¤‡å¥½ç¿»è¯‘çš„targetsï¼Œä½¿ç”¨<code>as_target_tokenizer</code>æ¥ä¸ºtargetsè®¾ç½®tokenizerï¼š</strong></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> tokenizer.as_target_tokenizer():</span><br><span class="line">    <span class="built_in">print</span>(tokenizer([<span class="string">&quot;Hello, this one sentence!&quot;</span>, <span class="string">&quot;This is another sentence.&quot;</span>]))</span><br><span class="line"><span class="comment">#&#123;&#x27;input_ids&#x27;: [[8774, 6, 48, 80, 7142, 55, 1], [100, 19, 430, 7142, 5, 1]], &#x27;attention_mask&#x27;: [[1, 1, 1, 1, 1, 1, 1], [1, 1, 1, 1, 1, 1]]&#125;</span></span><br></pre></td></tr></table></figure>
<p><strong>å¦‚æœä½¿ç”¨çš„æ˜¯T5é¢„è®­ç»ƒæ¨¡å‹çš„checkpointsï¼ˆæ¯”å¦‚æˆ‘ä»¬è¿™é‡Œç”¨çš„t5-smallï¼‰ï¼Œéœ€è¦å¯¹ç‰¹æ®Šçš„å‰ç¼€è¿›è¡Œæ£€æŸ¥ã€‚T5ä½¿ç”¨ç‰¹æ®Šçš„å‰ç¼€ï¼ˆ<code>&quot;summarize: &quot;</code>ï¼‰æ¥å‘Šè¯‰æ¨¡å‹å…·ä½“è¦åšçš„ä»»åŠ¡</strong>ï¼Œå…·ä½“å‰ç¼€ä¾‹å­å¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> model_checkpoint <span class="keyword">in</span> [<span class="string">&quot;t5-small&quot;</span>, <span class="string">&quot;t5-base&quot;</span>, <span class="string">&quot;t5-larg&quot;</span>, <span class="string">&quot;t5-3b&quot;</span>, <span class="string">&quot;t5-11b&quot;</span>]:</span><br><span class="line">    prefix = <span class="string">&quot;summarize: &quot;</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    prefix = <span class="string">&quot;&quot;</span></span><br></pre></td></tr></table></figure>
<p>ç°åœ¨æˆ‘ä»¬å¯ä»¥æŠŠä¸Šé¢çš„å†…å®¹æ”¾åœ¨ä¸€èµ·ç»„æˆé¢„å¤„ç†å‡½æ•°<code>preprocess_function</code>ã€‚å¯¹æ ·æœ¬è¿›è¡Œé¢„å¤„ç†çš„æ—¶å€™ï¼Œ<strong>ä½¿ç”¨<code>truncation=True</code>å‚æ•°æ¥ç¡®ä¿è¶…é•¿æ–‡æœ¬è¢«æˆªæ–­ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œå¯¹ä¸æ¯”è¾ƒçŸ­çš„å¥å­ä¼šè‡ªåŠ¨paddingã€‚</strong><code>max_input_length</code>æ§åˆ¶äº†è¾“å…¥æ–‡æœ¬çš„é•¿åº¦ï¼Œ<code>max_target_length</code>æ§åˆ¶äº†æ‘˜è¦çš„æœ€é•¿é•¿åº¦ã€‚</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">max_input_length = <span class="number">1024</span></span><br><span class="line">max_target_length = <span class="number">128</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">preprocess_function</span>(<span class="params">examples</span>):</span></span><br><span class="line">    inputs = [prefix + doc <span class="keyword">for</span> doc <span class="keyword">in</span> examples[<span class="string">&quot;document&quot;</span>]]</span><br><span class="line">    model_inputs = tokenizer(inputs, max_length=max_input_length, truncation=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Setup the tokenizer for targets</span></span><br><span class="line">    <span class="keyword">with</span> tokenizer.as_target_tokenizer():</span><br><span class="line">        labels = tokenizer(examples[<span class="string">&quot;summary&quot;</span>], max_length=max_target_length, truncation=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    model_inputs[<span class="string">&quot;labels&quot;</span>] = labels[<span class="string">&quot;input_ids&quot;</span>]</span><br><span class="line">    <span class="keyword">return</span> model_inputs</span><br></pre></td></tr></table></figure>
<p>ä»¥ä¸Šçš„é¢„å¤„ç†å‡½æ•°å¯ä»¥å¤„ç†ä¸€ä¸ªæ ·æœ¬ï¼Œä¹Ÿå¯ä»¥å¤„ç†å¤šä¸ªæ ·æœ¬exapmlesã€‚å¦‚æœæ˜¯å¤„ç†å¤šä¸ªæ ·æœ¬ï¼Œåˆ™è¿”å›çš„æ˜¯å¤šä¸ªæ ·æœ¬è¢«é¢„å¤„ç†ä¹‹åçš„ç»“æœlistã€‚</p>
<p>æ¥ä¸‹æ¥<strong>ä½¿ç”¨mapå‡½æ•°</strong>å¯¹æ•°æ®é›†**datasetsé‡Œé¢ä¸‰ä¸ªæ ·æœ¬é›†åˆçš„æ‰€æœ‰æ ·æœ¬è¿›è¡Œé¢„å¤„ç†ï¼Œ**å°†é¢„å¤„ç†å‡½æ•°<code>preprocess_function</code>åº”ç”¨åˆ°ï¼ˆmap)æ‰€æœ‰æ ·æœ¬ä¸Šã€‚å‚æ•°<code>batched=True</code>å¯ä»¥æ‰¹é‡å¯¹æ–‡æœ¬è¿›è¡Œç¼–ç ã€‚è¿™æ˜¯ä¸ºäº†å……åˆ†åˆ©ç”¨å‰é¢åŠ è½½fast_tokenizerçš„ä¼˜åŠ¿ï¼Œå®ƒå°†ä½¿ç”¨å¤šçº¿ç¨‹å¹¶å‘åœ°å¤„ç†æ‰¹ä¸­çš„æ–‡æœ¬ã€‚</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">tokenized_datasets = raw_datasets.<span class="built_in">map</span>(preprocess_function, batched=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>
<h2 id="å¾®è°ƒé¢„è®­ç»ƒæ¨¡å‹"><a class="markdownIt-Anchor" href="#å¾®è°ƒé¢„è®­ç»ƒæ¨¡å‹"></a> å¾®è°ƒé¢„è®­ç»ƒæ¨¡å‹</h2>
<p>æ•°æ®å·²ç»å‡†å¤‡å¥½äº†ï¼Œæˆ‘ä»¬éœ€è¦ä¸‹è½½å¹¶åŠ è½½é¢„è®­ç»ƒæ¨¡å‹ï¼Œç„¶åå¾®è°ƒé¢„è®­ç»ƒæ¨¡å‹ã€‚</p>
<h3 id="åŠ è½½é¢„è®­ç»ƒæ¨¡å‹"><a class="markdownIt-Anchor" href="#åŠ è½½é¢„è®­ç»ƒæ¨¡å‹"></a> åŠ è½½é¢„è®­ç»ƒæ¨¡å‹</h3>
<p>åš<strong>seq2seqä»»åŠ¡ï¼Œé‚£ä¹ˆéœ€è¦ä¸€ä¸ªèƒ½è§£å†³è¿™ä¸ªä»»åŠ¡çš„æ¨¡å‹ç±»ã€‚æˆ‘ä»¬ä½¿ç”¨<code>AutoModelForSeq2SeqLM</code> è¿™ä¸ªç±»</strong>ã€‚</p>
<p>å’Œä¹‹å‰å‡ ç¯‡åšå®¢æåˆ°çš„åŠ è½½æ–¹å¼ç›¸åŒä¸å†èµ˜è¿°ã€‚</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> transformers <span class="keyword">import</span> AutoModelForSeq2SeqLM, </span><br><span class="line">model = AutoModelForSeq2SeqLM.from_pretrained(model_checkpoint)</span><br></pre></td></tr></table></figure>
<h3 id="è®¾å®šè®­ç»ƒå‚æ•°"><a class="markdownIt-Anchor" href="#è®¾å®šè®­ç»ƒå‚æ•°"></a> è®¾å®šè®­ç»ƒå‚æ•°</h3>
<p>ä¸ºäº†èƒ½å¤Ÿå¾—åˆ°ä¸€ä¸ª**<code>Seq2SeqTrainer</code>è®­ç»ƒå·¥å…·**ï¼Œæˆ‘ä»¬è¿˜éœ€è¦<strong>è®­ç»ƒçš„è®¾å®š/å‚æ•° <a target="_blank" rel="noopener" href="https://huggingface.co/transformers/main_classes/trainer.html#transformers.Seq2SeqTrainingArguments"><code>Seq2SeqTrainingArguments</code></a>ã€‚è¿™ä¸ªè®­ç»ƒè®¾å®šåŒ…å«äº†èƒ½å¤Ÿå®šä¹‰è®­ç»ƒè¿‡ç¨‹çš„æ‰€æœ‰å±æ€§</strong>ã€‚</p>
<p>ç”±äºæ•°æ®é›†æ¯”è¾ƒå¤§ï¼Œ<code>Seq2SeqTrainer</code>è®­ç»ƒæ—¶ä¼šåŒæ—¶ä¸æ–­ä¿å­˜æ¨¡å‹ï¼Œæˆ‘ä»¬ç”¨<code>save_total_limit=3</code>å‚æ•°æ§åˆ¶è‡³å¤šä¿å­˜3ä¸ªæ¨¡å‹ã€‚</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> transformers <span class="keyword">import</span> Seq2SeqTrainingArguments</span><br><span class="line">batch_size = <span class="number">16</span></span><br><span class="line">args = Seq2SeqTrainingArguments(</span><br><span class="line">    <span class="string">&quot;test-summarization&quot;</span>,</span><br><span class="line">    evaluation_strategy = <span class="string">&quot;epoch&quot;</span>,</span><br><span class="line">    learning_rate=<span class="number">2e-5</span>,</span><br><span class="line">    per_device_train_batch_size=batch_size,</span><br><span class="line">    per_device_eval_batch_size=batch_size,</span><br><span class="line">    weight_decay=<span class="number">0.01</span>,</span><br><span class="line">    save_total_limit=<span class="number">3</span>,<span class="comment">#è‡³å¤šä¿å­˜3ä¸ªæ¨¡å‹</span></span><br><span class="line">    num_train_epochs=<span class="number">1</span>,</span><br><span class="line">    predict_with_generate=<span class="literal">True</span>,</span><br><span class="line">    fp16=<span class="literal">True</span>,</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<h3 id="æ•°æ®æ”¶é›†å™¨data-collator"><a class="markdownIt-Anchor" href="#æ•°æ®æ”¶é›†å™¨data-collator"></a> æ•°æ®æ”¶é›†å™¨data collator</h3>
<p>æ¥ä¸‹æ¥éœ€è¦å‘Šè¯‰<code>Trainer</code>å¦‚ä½•ä»é¢„å¤„ç†çš„è¾“å…¥æ•°æ®ä¸­æ„é€ batchã€‚æˆ‘ä»¬ä½¿ç”¨æ•°æ®æ”¶é›†å™¨<code>DataCollatorForSeq2Seq</code>ï¼Œå°†ç»é¢„å¤„ç†çš„è¾“å…¥åˆ†batchå†æ¬¡å¤„ç†åå–‚ç»™æ¨¡å‹ã€‚</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> transformers <span class="keyword">import</span> DataCollatorForSeq2Seq</span><br><span class="line">data_collator = DataCollatorForSeq2Seq(tokenizer, model=model)</span><br></pre></td></tr></table></figure>
<h3 id="å®šä¹‰è¯„ä¼°æ–¹æ³•"><a class="markdownIt-Anchor" href="#å®šä¹‰è¯„ä¼°æ–¹æ³•"></a> å®šä¹‰è¯„ä¼°æ–¹æ³•</h3>
<p>æˆ‘ä»¬ä½¿ç”¨<code>'rouge'</code>æŒ‡æ ‡ï¼Œåˆ©ç”¨<code>metric.compute</code>è®¡ç®—è¯¥æŒ‡æ ‡å¯¹æ¨¡å‹è¿›è¡Œè¯„ä¼°ã€‚</p>
<p>ä½¿ç”¨<code>metric.compute</code>å¯¹æ¯”predictionså’Œlabelsï¼Œä»è€Œè®¡ç®—å¾—åˆ†ã€‚predictionså’Œlabelséƒ½éœ€è¦æ˜¯ä¸€ä¸ªlistã€‚å…·ä½“æ ¼å¼è§ä¸‹é¢çš„ä¾‹å­ï¼š</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">fake_preds = [<span class="string">&quot;hello there&quot;</span>, <span class="string">&quot;general kenobi&quot;</span>]</span><br><span class="line">fake_labels = [<span class="string">&quot;hello there&quot;</span>, <span class="string">&quot;general kenobi&quot;</span>]</span><br><span class="line">metric.compute(predictions=fake_preds, references=fake_labels)</span><br><span class="line"><span class="comment">#&#123;&#x27;rouge1&#x27;: AggregateScore(low=Score(precision=1.0, recall=1.0, fmeasure=1.0), mid=Score(precision=1.0, recall=1.0, fmeasure=1.0), high=Score(precision=1.0, recall=1.0, fmeasure=1.0)),</span></span><br><span class="line"><span class="comment"># &#x27;rouge2&#x27;: AggregateScore(low=Score(precision=1.0, recall=1.0, fmeasure=1.0), mid=Score(precision=1.0, recall=1.0, fmeasure=1.0), high=Score(precision=1.0, recall=1.0, fmeasure=1.0)),</span></span><br><span class="line"><span class="comment"># &#x27;rougeL&#x27;: AggregateScore(low=Score(precision=1.0, recall=1.0, fmeasure=1.0), mid=Score(precision=1.0, recall=1.0, fmeasure=1.0), high=Score(precision=1.0, recall=1.0, fmeasure=1.0)),</span></span><br><span class="line"><span class="comment"># &#x27;rougeLsum&#x27;: AggregateScore(low=Score(precision=1.0, recall=1.0, fmeasure=1.0), mid=Score(precision=1.0, recall=1.0, fmeasure=1.0), high=Score(precision=1.0, recall=1.0, fmeasure=1.0))&#125;</span></span><br></pre></td></tr></table></figure>
<p>å°†æ¨¡å‹é¢„æµ‹é€å…¥è¯„ä¼°ä¹‹å‰ï¼Œè¿˜éœ€è¦å†™<code>postprocess_text</code>å‡½æ•°åšä¸€äº›æ•°æ®åå¤„ç†ã€‚</p>
<p><a target="_blank" rel="noopener" href="http://www.nltk.org/">nltk</a>æ˜¯ä¸€ä¸ªè‡ªç„¶è¯­è¨€å¤„ç†çš„pythonå·¥å…·åŒ…ï¼Œæˆ‘ä»¬è¿™é‡Œç”¨åˆ°äº†å…¶ä¸­ä¸€ä¸ªæŒ‰å¥å­åˆ†å‰²çš„å‡½æ•°<code>nltk.sent_tokenize()</code>ã€‚</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> nltk</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">compute_metrics</span>(<span class="params">eval_pred</span>):</span></span><br><span class="line">    predictions, labels = eval_pred</span><br><span class="line">    decoded_preds = tokenizer.batch_decode(predictions, skip_special_tokens=<span class="literal">True</span>)</span><br><span class="line">    <span class="comment"># Replace -100 in the labels as we can&#x27;t decode them.</span></span><br><span class="line">    labels = np.where(labels != -<span class="number">100</span>, labels, tokenizer.pad_token_id)</span><br><span class="line">    decoded_labels = tokenizer.batch_decode(labels, skip_special_tokens=<span class="literal">True</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Rouge expects a newline after each sentence</span></span><br><span class="line">    decoded_preds = [<span class="string">&quot;\n&quot;</span>.join(nltk.sent_tokenize(pred.strip())) <span class="keyword">for</span> pred <span class="keyword">in</span> decoded_preds] <span class="comment">#æŒ‰å¥å­åˆ†å‰²åæ¢è¡Œç¬¦æ‹¼æ¥</span></span><br><span class="line">    decoded_labels = [<span class="string">&quot;\n&quot;</span>.join(nltk.sent_tokenize(label.strip())) <span class="keyword">for</span> label <span class="keyword">in</span> decoded_labels]</span><br><span class="line">    </span><br><span class="line">    result = metric.compute(predictions=decoded_preds, references=decoded_labels, use_stemmer=<span class="literal">True</span>)</span><br><span class="line">    <span class="comment"># Extract a few results</span></span><br><span class="line">    result = &#123;key: value.mid.fmeasure * <span class="number">100</span> <span class="keyword">for</span> key, value <span class="keyword">in</span> result.items()&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Add mean generated length</span></span><br><span class="line">    prediction_lens = [np.count_nonzero(pred != tokenizer.pad_token_id) <span class="keyword">for</span> pred <span class="keyword">in</span> predictions]</span><br><span class="line">    result[<span class="string">&quot;gen_len&quot;</span>] = np.mean(prediction_lens)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> &#123;k: <span class="built_in">round</span>(v, <span class="number">4</span>) <span class="keyword">for</span> k, v <span class="keyword">in</span> result.items()&#125;</span><br></pre></td></tr></table></figure>
<h3 id="å¼€å§‹è®­ç»ƒ"><a class="markdownIt-Anchor" href="#å¼€å§‹è®­ç»ƒ"></a> å¼€å§‹è®­ç»ƒ</h3>
<p>å°†æ•°æ®/æ¨¡å‹/å‚æ•°ä¼ å…¥<code>Trainer</code>å³å¯ï¼š</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> transformers <span class="keyword">import</span> Seq2SeqTrainer</span><br><span class="line">trainer = Seq2SeqTrainer(</span><br><span class="line">    model,</span><br><span class="line">    args,</span><br><span class="line">    train_dataset=tokenized_datasets[<span class="string">&quot;train&quot;</span>],</span><br><span class="line">    eval_dataset=tokenized_datasets[<span class="string">&quot;validation&quot;</span>],</span><br><span class="line">    data_collator=data_collator,</span><br><span class="line">    tokenizer=tokenizer,</span><br><span class="line">    compute_metrics=compute_metrics</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>è°ƒç”¨<code>train</code>æ–¹æ³•å¼€å§‹è®­ç»ƒï¼š</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">trainer.train()</span><br></pre></td></tr></table></figure>
<h2 id="å‚è€ƒæ–‡çŒ®"><a class="markdownIt-Anchor" href="#å‚è€ƒæ–‡çŒ®"></a> å‚è€ƒæ–‡çŒ®</h2>
<p><a target="_blank" rel="noopener" href="https://github.com/datawhalechina/learn-nlp-with-transformers/blob/main/docs/%E7%AF%87%E7%AB%A04-%E4%BD%BF%E7%94%A8Transformers%E8%A7%A3%E5%86%B3NLP%E4%BB%BB%E5%8A%A1/4.7-%E7%94%9F%E6%88%90%E4%BB%BB%E5%8A%A1-%E6%91%98%E8%A6%81%E7%94%9F%E6%88%90.md">4.7-ç”Ÿæˆä»»åŠ¡-æ‘˜è¦ç”Ÿæˆ.md</a></p>
<p><a target="_blank" rel="noopener" href="https://huggingface.co/transformers">transformerså®˜æ–¹æ–‡æ¡£</a></p>
<p><a href="https://ifwind.github.io/2021/08/24/BERT%E7%9B%B8%E5%85%B3%E2%80%94%E2%80%94%EF%BC%887%EF%BC%89%E6%8A%8ABERT%E5%BA%94%E7%94%A8%E5%88%B0%E4%B8%8B%E6%B8%B8%E4%BB%BB%E5%8A%A1/">BERTç›¸å…³â€”â€”ï¼ˆ7ï¼‰å°†BERTåº”ç”¨åˆ°ä¸‹æ¸¸ä»»åŠ¡</a></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">æ–‡ç« ä½œè€…: </span><span class="post-copyright-info"><a href="mailto:undefined">å†¬äº</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">æ–‡ç« é“¾æ¥: </span><span class="post-copyright-info"><a href="https://ifwind.github.io/2021/08/31/BERT%E5%AE%9E%E6%88%98%E2%80%94%E2%80%94%EF%BC%886%EF%BC%89%E7%94%9F%E6%88%90%E4%BB%BB%E5%8A%A1-%E6%91%98%E8%A6%81%E7%94%9F%E6%88%90/">https://ifwind.github.io/2021/08/31/BERT%E5%AE%9E%E6%88%98%E2%80%94%E2%80%94%EF%BC%886%EF%BC%89%E7%94%9F%E6%88%90%E4%BB%BB%E5%8A%A1-%E6%91%98%E8%A6%81%E7%94%9F%E6%88%90/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">ç‰ˆæƒå£°æ˜: </span><span class="post-copyright-info">æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜æ¥è‡ª <a href="https://ifwind.github.io" target="_blank">å†¬äºçš„åšå®¢</a>ï¼</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/">æ·±åº¦å­¦ä¹ </a><a class="post-meta__tags" href="/tags/NLP/">NLP</a><a class="post-meta__tags" href="/tags/BERT/">BERT</a></div><div class="post_share"><div class="social-share" data-image="/2021/08/26/BERT%E5%AE%9E%E6%88%98%E2%80%94%E2%80%94%EF%BC%881%EF%BC%89%E6%96%87%E6%9C%AC%E5%88%86%E7%B1%BB/huggingFace.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2021/08/31/BERT%E5%AE%9E%E6%88%98%E2%80%94%E2%80%94%EF%BC%887%EF%BC%89%E7%94%9F%E6%88%90%E4%BB%BB%E5%8A%A1-%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B/"><img class="prev-cover" src="/2021/08/26/BERT%E5%AE%9E%E6%88%98%E2%80%94%E2%80%94%EF%BC%881%EF%BC%89%E6%96%87%E6%9C%AC%E5%88%86%E7%B1%BB/huggingFace.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">ä¸Šä¸€ç¯‡</div><div class="prev_info">BERTå®æˆ˜â€”â€”ï¼ˆ7ï¼‰ç”Ÿæˆä»»åŠ¡-è¯­è¨€æ¨¡å‹</div></div></a></div><div class="next-post pull-right"><a href="/2021/08/31/BERT%E5%AE%9E%E6%88%98%E2%80%94%E2%80%94%EF%BC%885%EF%BC%89%E7%94%9F%E6%88%90%E4%BB%BB%E5%8A%A1-%E6%9C%BA%E5%99%A8%E7%BF%BB%E8%AF%91/"><img class="next-cover" src="/2021/08/26/BERT%E5%AE%9E%E6%88%98%E2%80%94%E2%80%94%EF%BC%881%EF%BC%89%E6%96%87%E6%9C%AC%E5%88%86%E7%B1%BB/huggingFace.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">ä¸‹ä¸€ç¯‡</div><div class="next_info">BERTå®æˆ˜â€”â€”ï¼ˆ5ï¼‰ç”Ÿæˆä»»åŠ¡-æœºå™¨ç¿»è¯‘</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> ç›¸å…³æ¨è</span></div><div class="relatedPosts-list"><div><a href="/2021/08/20/BERTç›¸å…³â€”â€”ï¼ˆ1ï¼‰è¯­è¨€æ¨¡å‹/" title="BERTç›¸å…³â€”â€”ï¼ˆ1ï¼‰è¯­è¨€æ¨¡å‹"><img class="cover" src="/2021/08/20/BERT%E7%9B%B8%E5%85%B3%E2%80%94%E2%80%94%EF%BC%881%EF%BC%89%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B/BERT%E5%AE%B6%E6%97%8F.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-08-20</div><div class="title">BERTç›¸å…³â€”â€”ï¼ˆ1ï¼‰è¯­è¨€æ¨¡å‹</div></div></a></div><div><a href="/2021/08/20/BERTç›¸å…³â€”â€”ï¼ˆ2ï¼‰Contextualized_Word_Embeddingå’ŒELMOæ¨¡å‹/" title="BERTç›¸å…³â€”â€”ï¼ˆ2ï¼‰Contextualized Word Embeddingå’ŒELMOæ¨¡å‹"><img class="cover" src="/2021/08/20/BERT%E7%9B%B8%E5%85%B3%E2%80%94%E2%80%94%EF%BC%881%EF%BC%89%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B/BERT%E5%AE%B6%E6%97%8F.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-08-20</div><div class="title">BERTç›¸å…³â€”â€”ï¼ˆ2ï¼‰Contextualized Word Embeddingå’ŒELMOæ¨¡å‹</div></div></a></div><div><a href="/2021/08/20/BERTç›¸å…³â€”â€”ï¼ˆ3ï¼‰BERTæ¨¡å‹/" title="BERTç›¸å…³â€”â€”ï¼ˆ3ï¼‰BERTæ¨¡å‹"><img class="cover" src="/2021/08/20/BERT%E7%9B%B8%E5%85%B3%E2%80%94%E2%80%94%EF%BC%881%EF%BC%89%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B/BERT%E5%AE%B6%E6%97%8F.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-08-20</div><div class="title">BERTç›¸å…³â€”â€”ï¼ˆ3ï¼‰BERTæ¨¡å‹</div></div></a></div><div><a href="/2021/08/20/BERTç›¸å…³â€”â€”ï¼ˆ4ï¼‰GPTæ¨¡å‹/" title="BERTç›¸å…³â€”â€”ï¼ˆ4ï¼‰GPT-2æ¨¡å‹"><img class="cover" src="/2021/08/20/BERT%E7%9B%B8%E5%85%B3%E2%80%94%E2%80%94%EF%BC%881%EF%BC%89%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B/BERT%E5%AE%B6%E6%97%8F.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-08-20</div><div class="title">BERTç›¸å…³â€”â€”ï¼ˆ4ï¼‰GPT-2æ¨¡å‹</div></div></a></div><div><a href="/2021/08/22/BERTç›¸å…³â€”â€”ï¼ˆ5ï¼‰Pre-train Model/" title="BERTç›¸å…³â€”â€”ï¼ˆ5ï¼‰Pre-train Model"><img class="cover" src="/2021/08/20/BERT%E7%9B%B8%E5%85%B3%E2%80%94%E2%80%94%EF%BC%881%EF%BC%89%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B/BERT%E5%AE%B6%E6%97%8F.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-08-22</div><div class="title">BERTç›¸å…³â€”â€”ï¼ˆ5ï¼‰Pre-train Model</div></div></a></div><div><a href="/2021/08/24/BERTç›¸å…³â€”â€”ï¼ˆ7ï¼‰æŠŠBERTåº”ç”¨åˆ°ä¸‹æ¸¸ä»»åŠ¡/" title="BERTç›¸å…³â€”â€”ï¼ˆ7ï¼‰å°†BERTåº”ç”¨åˆ°ä¸‹æ¸¸ä»»åŠ¡"><img class="cover" src="/2021/08/20/BERT%E7%9B%B8%E5%85%B3%E2%80%94%E2%80%94%EF%BC%881%EF%BC%89%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B/BERT%E5%AE%B6%E6%97%8F.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-08-24</div><div class="title">BERTç›¸å…³â€”â€”ï¼ˆ7ï¼‰å°†BERTåº”ç”¨åˆ°ä¸‹æ¸¸ä»»åŠ¡</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> è¯„è®º</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>ç›®å½•</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#bert%E5%AE%9E%E6%88%986%E7%94%9F%E6%88%90%E4%BB%BB%E5%8A%A1-%E6%91%98%E8%A6%81%E7%94%9F%E6%88%90"><span class="toc-number">1.</span> <span class="toc-text"> BERTå®æˆ˜â€”â€”ï¼ˆ6ï¼‰ç”Ÿæˆä»»åŠ¡-æ‘˜è¦ç”Ÿæˆ</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%95%E8%A8%80"><span class="toc-number">1.1.</span> <span class="toc-text"> å¼•è¨€</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%BB%E5%8A%A1%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.1.1.</span> <span class="toc-text"> ä»»åŠ¡ä»‹ç»</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%8D%E6%9C%9F%E5%87%86%E5%A4%87"><span class="toc-number">1.1.2.</span> <span class="toc-text"> å‰æœŸå‡†å¤‡</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%8A%A0%E8%BD%BD"><span class="toc-number">1.2.</span> <span class="toc-text"> æ•°æ®åŠ è½½</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E9%9B%86%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.2.1.</span> <span class="toc-text"> æ•°æ®é›†ä»‹ç»</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%A0%E8%BD%BD%E6%95%B0%E6%8D%AE"><span class="toc-number">1.2.2.</span> <span class="toc-text"> åŠ è½½æ•°æ®</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E9%A2%84%E5%A4%84%E7%90%86"><span class="toc-number">1.3.</span> <span class="toc-text"> æ•°æ®é¢„å¤„ç†</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96tokenizer"><span class="toc-number">1.3.1.</span> <span class="toc-text"> åˆå§‹åŒ–Tokenizer</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BD%AC%E5%8C%96%E6%88%90%E5%AF%B9%E5%BA%94%E4%BB%BB%E5%8A%A1%E8%BE%93%E5%85%A5%E6%A8%A1%E5%9E%8B%E7%9A%84%E6%A0%BC%E5%BC%8F"><span class="toc-number">1.3.2.</span> <span class="toc-text"> è½¬åŒ–æˆå¯¹åº”ä»»åŠ¡è¾“å…¥æ¨¡å‹çš„æ ¼å¼</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BE%AE%E8%B0%83%E9%A2%84%E8%AE%AD%E7%BB%83%E6%A8%A1%E5%9E%8B"><span class="toc-number">1.4.</span> <span class="toc-text"> å¾®è°ƒé¢„è®­ç»ƒæ¨¡å‹</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%A0%E8%BD%BD%E9%A2%84%E8%AE%AD%E7%BB%83%E6%A8%A1%E5%9E%8B"><span class="toc-number">1.4.1.</span> <span class="toc-text"> åŠ è½½é¢„è®­ç»ƒæ¨¡å‹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%BE%E5%AE%9A%E8%AE%AD%E7%BB%83%E5%8F%82%E6%95%B0"><span class="toc-number">1.4.2.</span> <span class="toc-text"> è®¾å®šè®­ç»ƒå‚æ•°</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E6%94%B6%E9%9B%86%E5%99%A8data-collator"><span class="toc-number">1.4.3.</span> <span class="toc-text"> æ•°æ®æ”¶é›†å™¨data collator</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89%E8%AF%84%E4%BC%B0%E6%96%B9%E6%B3%95"><span class="toc-number">1.4.4.</span> <span class="toc-text"> å®šä¹‰è¯„ä¼°æ–¹æ³•</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%80%E5%A7%8B%E8%AE%AD%E7%BB%83"><span class="toc-number">1.4.5.</span> <span class="toc-text"> å¼€å§‹è®­ç»ƒ</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE"><span class="toc-number">1.5.</span> <span class="toc-text"> å‚è€ƒæ–‡çŒ®</span></a></li></ol></li></ol></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2022 By å†¬äº</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="é˜…è¯»æ¨¡å¼"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="æµ…è‰²å’Œæ·±è‰²æ¨¡å¼è½¬æ¢"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="å•æ å’ŒåŒæ åˆ‡æ¢"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="è®¾ç½®"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="ç›®å½•"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="ç›´è¾¾è¯„è®º"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="å›åˆ°é¡¶éƒ¨"><i class="fas fa-arrow-up"></i></button></div></div><div id="algolia-search"><div class="search-dialog"><div class="search-dialog__title" id="algolia-search-title">Algolia</div><div id="algolia-input-panel"><div id="algolia-search-input"></div></div><hr/><div id="algolia-search-results"><div id="algolia-hits"></div><div id="algolia-pagination"></div><div id="algolia-stats"></div></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script src="/js/search/algolia.js"></script><script>var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())</script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    loader: {
      source: {
        '[tex]/amsCd': '[tex]/amscd'
      }
    },
    tex: {
      inlineMath: [ ['$','$'], ["\\(","\\)"]],
      tags: 'ams'
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, ''],
        addClass: [200,() => {
          document.querySelectorAll('mjx-container:not([display=\'true\']').forEach( node => {
            const target = node.parentNode
            if (!target.classList.contains('has-jax')) {
              target.classList.add('mathjax-overflow')
            }
          })
        }, '', false]
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typeset()
}</script><script>function loadValine () {
  function initValine () {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: 'E4LPmFetYyaT4NwjEGOl0u8Q-gzGzoHsz',
      appKey: 'YKdl4HKX9W6jLSdPlypgEtDM',
      placeholder: 'Please leave your footprints',
      avatar: 'monsterid',
      meta: 'nick,mail,link'.split(','),
      pageSize: '10',
      lang: 'zh-CN',
      recordIP: false,
      serverURLs: 'https://e4lpmfet.lc-cn-n1-shared.com',
      emojiCDN: '',
      emojiMaps: "",
      enableQQ: false,
      path: window.location.pathname,
      requiredFields: ["nick,mail"],
      visitor: false
    }, null))
  }

  if (typeof Valine === 'function') initValine() 
  else getScript('https://cdn.jsdelivr.net/gh/HCLonely/Valine@latest/dist/Valine.min.js').then(initValine)
}

if ('Valine' === 'Valine' || !true) {
  if (true) btf.loadComment(document.getElementById('vcomment'),loadValine)
  else setTimeout(loadValine, 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script></div><script src="https://cdn.jsdelivr.net/npm/blueimp-md5@2.17.0/js/md5.min.js"></script><script>window.addEventListener('load', () => {
  const changeContent = (content) => {
    if (content === '') return content

    content = content.replace(/<img.*?src="(.*?)"?[^\>]+>/ig, '[å›¾ç‰‡]') // replace image link
    content = content.replace(/<a[^>]+?href=["']?([^"']+)["']?[^>]*>([^<]+)<\/a>/gi, '[é“¾æ¥]') // replace url
    content = content.replace(/<pre><code>.*?<\/pre>/gi, '[ä»£ç ]') // replace code
    content = content.replace(/<[^>]+>/g,"") // remove html tag

    if (content.length > 150) {
      content = content.substring(0,150) + '...'
    }
    return content
  }

  const getIcon = (icon, mail) => {
    if (icon) return icon
    let defaultIcon = '?d=monsterid'
    let iconUrl = `https://gravatar.loli.net/avatar/${md5(mail.toLowerCase()) + defaultIcon}`
    return iconUrl
  }

  const generateHtml = array => {
    let result = ''

    if (array.length) {
      for (let i = 0; i < array.length; i++) {
        result += '<div class=\'aside-list-item\'>'

        if (true) {
          const name = 'src'
          result += `<a href='${array[i].url}' class='thumbnail'><img ${name}='${array[i].avatar}' alt='${array[i].nick}'></a>`
        }

        result += `<div class='content'>
        <a class='comment' href='${array[i].url}'>${array[i].content}</a>
        <div class='name'><span>${array[i].nick} / </span><time datetime="${array[i].date}">${btf.diffDate(array[i].date, true)}</time></div>
        </div></div>`
      }
    } else {
      result += 'æ²¡æœ‰è¯„è®º'
    }

    let $dom = document.querySelector('#card-newest-comments .aside-list')
    $dom.innerHTML= result
    window.lazyLoadInstance && window.lazyLoadInstance.update()
    window.pjax && window.pjax.refresh($dom)
  }

  const getComment = () => {
    const serverURL = 'https://e4lpmfet.lc-cn-n1-shared.com'

    var settings = {
      "method": "GET",
      "headers": {
        "X-LC-Id": 'E4LPmFetYyaT4NwjEGOl0u8Q-gzGzoHsz',
        "X-LC-Key": 'YKdl4HKX9W6jLSdPlypgEtDM',
        "Content-Type": "application/json"
      },
    }

    fetch(`${serverURL}/1.1/classes/Comment?limit=6&order=-createdAt`,settings)
      .then(response => response.json())
      .then(data => {
        const valineArray = data.results.map(function (e) {
          return {
            'avatar': getIcon(e.QQAvatar, e.mail),
            'content': changeContent(e.comment),
            'nick': e.nick,
            'url': e.url + '#' + e.objectId,
            'date': e.updatedAt,
          }
        })
        saveToLocal.set('valine-newest-comments', JSON.stringify(valineArray), 10/(60*24))
        generateHtml(valineArray)
      }).catch(e => {
        const $dom = document.querySelector('#card-newest-comments .aside-list')
        $dom.innerHTML= "æ— æ³•è·å–è¯„è®ºï¼Œè¯·ç¡®è®¤ç›¸å…³é…ç½®æ˜¯å¦æ­£ç¡®"
      }) 
  }

  const newestCommentInit = () => {
    if (document.querySelector('#card-newest-comments .aside-list')) {
      const data = saveToLocal.get('valine-newest-comments')
      if (data) {
        generateHtml(JSON.parse(data))
      } else {
        getComment()
      }
    }
  }

  newestCommentInit()
  document.addEventListener('pjax:complete', newestCommentInit)
})</script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors = [
  'title',
  '#config-diff',
  '#body-wrap',
  '#rightside-config-hide',
  '#rightside-config-show',
  '.js-pjax'
]

if (false) {
  pjaxSelectors.unshift('meta[property="og:image"]', 'meta[property="og:title"]', 'meta[property="og:url"]')
}

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener toc scroll 
  window.removeEventListener('scroll', window.tocScrollFn)

  typeof preloader === 'object' && preloader.initLoading()
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // Analytics
  if (false) {
    MtaH5.pgv()
  }

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()

  typeof preloader === 'object' && preloader.endLoading()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>